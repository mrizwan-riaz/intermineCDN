(function(e){if(typeof jQuery=="undefined")return null;var t=jQuery;if(!t.support.cors&&window.XDomainRequest){var n=/^https?:\/\//i,r=/^get|post$/i,i=new RegExp("^"+location.protocol,"i"),s=/\/json/i,o=/\/xml/i,u=function(e,t){this.userOptions=e,this.options=t,this.userType=(e.dataType||"").toLowerCase(),_.bindAll(this)};u.prototype.constructor=u,u.prototype.send=function(e,n){this.xdr=new XDomainRequest,this.complete=n;var r=this.xdr;/^\d+$/.test(this.userOptions.timeout)&&(r.timeout=this.userOptions.timeout),r.ontimeout=function(){n(500,"timeout")},r.onerror=function(){n(500,"error",{text:r.responseText})},r.onload=this.onLoad;var i=this.userOptions.data&&t.param(this.userOptions.data)||"";r.open(this.options.type,this.options.url),r.send(i)},u.prototype.abort=function(){xdr&&xdr.abort()},u.prototype.onLoad=function(){var e=this.xdr,n="Content-Length: "+e.responseText.length+"\r\nContent-Type: "+e.contentType,r={code:200,message:"success"},i={text:e.responseText};try{if(this.userType==="json"||this.userType!=="text"&&s.test(e.contentType))try{i.json=t.parseJSON(e.responseText)}catch(u){r.code=500,r.message="parseerror"}else if(this.userType==="xml"||this.userType!=="text"&&o.test(e.contentType)){var a=new ActiveXObject("Microsoft.XMLDOM");a.async=!1;try{a.loadXML(e.responseText)}catch(u){a=undefined}if(!a||!a.documentElement||a.getElementsByTagName("parsererror").length)throw r.code=500,r.message="parseerror","Invalid XML: "+e.responseText;i.xml=a}}catch(f){throw f}finally{this.complete(r.code,r.message,i,n)}},jQuery.ajaxTransport("text html xml json",function(e,t,s){if(e.crossDomain&&e.async&&r.test(e.type)&&n.test(t.url)&&i.test(t.url))return new u(t,e)}),t.support.cors=!0}}).call(this,typeof exports=="undefined"?this:exports),function(){var e,t,n,r,i,s,o,u,a;e=typeof exports!="undefined",e?r=exports:(i=(u=this.intermine)!=null?u:this.intermine={},r=(a=i.imjs)!=null?a:i.imjs={}),r.VERSION="unknown",e?(n=require("fs"),s=require("path"),process.mainModule!=null&&(t=n.readFileSync(s.join(__dirname,"..","package.json"),"utf8"),o=JSON.parse(t),r.VERSION=o.version)):r.VERSION="2.1.3"}.call(this),function(){var e,t,n,r,i;e=typeof exports!="undefined",e?t=exports:(n=(r=this.intermine)!=null?r:this.intermine={},t=(i=n.constants)!=null?i:n.constants={}),t.ACCEPT_HEADER={json:"application/json",jsonobjects:"application/json;type=objects",jsontable:"application/json;type=table",jsonrows:"application/json;type=rows",jsoncount:"application/json;type=count",jsonp:"application/javascript",jsonpobjects:"application/javascript;type=objects",jsonptable:"application/javascript;type=table",jsonprows:"application/javascript;type=rows",jsonpcount:"application/javascript;type=count"}}.call(this),function(){var e,t,n,r,i,s,o,u;e=typeof exports!="undefined",e||(Array.prototype.map==null&&(Array.prototype.map=function(e){var t,n,r,i;i=[];for(n=0,r=this.length;n<r;n++)t=this[n],i.push(e(t));return i}),Array.prototype.filter==null&&(Array.prototype.filter=function(e){var t,n,r,i;i=[];for(n=0,r=this.length;n<r;n++)t=this[n],e(t)&&i.push(t);return i}),Array.prototype.reduce==null&&(Array.prototype.reduce=function(e,t){var n,r,i,s,o;i=this.slice(),n=arguments.length<2?i.pop():t;for(s=0,o=i.length;s<o;s++)r=i[s],n=e(n,r);return n}),Array.prototype.forEach==null&&(Array.prototype.forEach=function(e,t){var n,r,i,s,o;if(!e)throw new Error("No function provided");o=[];for(n=i=0,s=this.length;i<s;n=++i)r=this[n],o.push(e.call(t!=null?t:this,r,n,this));return o}),(i=this.console)==null&&(this.console={log:function(){},error:function(){},debug:function(){}}),(s=(t=this.console).log)==null&&(t.log=function(){}),(o=(n=this.console).error)==null&&(n.error=function(){}),(u=(r=this.console).debug)==null&&(r.debug=function(){}))}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c=[].slice,h={}.hasOwnProperty;t=typeof exports!="undefined",s=typeof exports!="undefined"&&exports!==null?exports:this,t?(e=require("underscore.deferred").Deferred,u=require("underscore")._):(e=s.jQuery.Deferred,u=s._,(f=s.intermine)==null&&(s.intermine={}),(l=(a=s.intermine).funcutils)==null&&(a.funcutils={}),s=s.intermine.funcutils),s.curry=function(){var e,t;return t=arguments[0],e=2<=arguments.length?c.call(arguments,1):[],function(){var n;return n=1<=arguments.length?c.call(arguments,0):[],t.apply(null,e.concat(n))}},s.error=function(t){return e(function(){return this.reject(new Error(t))}).promise()},s.success=o=function(){var t;return t=1<=arguments.length?c.call(arguments,0):[],e(function(){return this.resolve.apply(this,t)}).promise()},s.fold=r=function(e,t){return function(n){var r,i,s;if(n.reduce!=null)return n.reduce(t,e);i=e;for(r in n)s=n[r],i=i!=null?t(i,r,s):{k:s};return i}},s.take=function(e){return function(t){return e!=null?t.slice(0,e-1+1||9e9):t}},s.omap=function(e){return function(t){var n;return n=function(t,n,r){var i,s,o;return o=e(n,r),i=o[0],s=o[1],t[i]=s,t},s.fold({},n)(t)}},s.copy=s.omap(function(e,t){return[e,t]}),s.partition=function(e){return function(t){var n,r,i,s,o;r=[],n=[];for(s=0,o=t.length;s<o;s++)i=t[s],e(i)?r.push(i):n.push(i);return[r,n]}},s.concatMap=function(e){return function(t){var n,r,i,s,o,u,a;i=void 0;for(u=0,a=t.length;u<a;u++)o=t[u],n=e(o),i=function(){var e;if(i===void 0)return n;if((e=typeof n)==="string"||e==="number")return i+n;if(n.slice!=null)return i.concat(n);for(r in n)s=n[r],i[r]=s;return i}();return i}},s.flatMap=s.concatMap,s.sum=s.concatMap(function(){}),s.AND=function(e,t){return e&&t},s.OR=function(e,t){return e||t},s.NOT=function(e){return!e},s.id=i=function(e){return e},s.any=function(e,t){var n,r,s;t==null&&(t=i);for(r=0,s=e.length;r<s;r++){n=e[r];if(t(n))return!0}return!1},s.invoke=function(){var t,n;return n=arguments[0],t=2<=arguments.length?c.call(arguments,1):[],function(r){var i;return((i=r[n])!=null?i.apply:void 0)?r[n].apply(r,t):e().reject("No method: "+n).promise()}},s.invokeWith=function(e,t,n){return t==null&&(t=[]),n==null&&(n=null),function(r){return r[e].apply(n||r,t)}},s.get=function(e){return function(t){return t[e]}},s.set=function(e,t){return function(n){var r,i;if(arguments.length===2)n[e]=t;else for(r in e){if(!h.call(e,r))continue;i=e[r],n[r]=i}return n}},s.flip=function(e){return function(){var t;return t=1<=arguments.length?c.call(arguments,0):[],e.apply(null,t.reverse())}},n=function(e,t){return"This service requires a service at version "+e+" or above. This one is at "+t},s.REQUIRES_VERSION=function(e,t,r){return e.fetchVersion().pipe(function(e){return e>=t?r():error(n(t,e))})},s.dejoin=function(e){var t,n,r,i,s;s=e.views;for(r=0,i=s.length;r<i;r++)n=s[r],t=n.split("."),t.length>2&&e.addJoin(t.slice(1,-1).join("."));return e},s.sequence=function(){var e,t;return t=1<=arguments.length?c.call(arguments,0):[],e=r(o(),function(e,t){return e.then(t)}),e(u.flatten(t))}}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p;f=this.jQuery,a=this.intermine,r=this.XDomainRequest,o=(h=a.http)!=null?h:a.http={},e=a.constants.ACCEPT_HEADER,p=a.funcutils,s=p.get,i=p.error,function(){var t,n,r;t={};for(n in e)r=e[n],t["text "+n]=f.parseJSON;return f.ajaxSetup({accepts:e,contents:{json:/json/},converters:t})}(),t=function(e){return f.Deferred(function(){return e.wasSuccessful?this.resolve(e):this.reject(e.error,e)})},n=function(e,t,n){try{return JSON.parse(e.responseText).error}catch(n){return t}},u=r!=null,l={PUT:"POST",DELETE:"GET"},u?(o.getMethod=function(e){var t;return(t=l[e])!=null?t:e},o.supports=function(e){return!(x in l)}):(o.getMethod=function(e){return e},o.supports=function(){return!0}),c=function(e){var t,n,r,i;return _.isArray(e)?e.length?(n=e[0],r=e[1],t=e[2],i=function(e){return _.each(e,n!=null?n:function(){})},[i,r,t]):[]:(i=function(t){return _.each(t,e!=null?e:function(){})},[i])},o.iterReq=function(e,t,n){return function(r,i,o,u,a){var f,l,c;return i==null&&(i={}),o==null&&(o=function(){}),u==null&&(u=function(){}),a==null&&(a=function(){}),arguments.length===2&&_.isFunction(i)&&(c=[i,{}],o=c[0],i=c[1]),f=_.extend({format:n},i,{query:r.toXML()}),l=function(e){return e.forEach(o)},this.makeRequest(e,t,f).fail(u).pipe(s("results")).done(o).done(a)}},o.doReq=function(e){var r;return r=e.error||this.errorHandler,e.error=_.compose(r,n),f.ajax(e).pipe(t).fail(r)}}.call(this),function(){var e,t,n,r,i,s;e=typeof exports!="undefined",i=typeof exports!="undefined"&&exports!==null?exports:(s=this.intermine)!=null?s:this.intermine={},n=function(e,t){var n,r,i;i=[];for(n in e)r=e[n],i.push(t[n]=r);return i},r=["attributes","references","collections"],t=function(){function e(e){var t,i,s,o,u,a;this.name=e.name,this.attributes=e.attributes,this.references=e.references,this.collections=e.collections,this.fields={},this.__parents__=arguments[0]["extends"];for(o=0,u=r.length;o<u;o++)i=r[o],n(this[i],this.fields);a=this.collections;for(s in a)t=a[s],t.isCollection=!0}return e.prototype.toString=function(){var e,t;return"[Table name="+this.name+", fields=["+function(){var n,r;n=this.fields,r=[];for(e in n)t=n[e],r.push(e);return r}.call(this)+"]]"},e.prototype.parents=function(){var e;return((e=this.__parents__)!=null?e:[]).slice()},e}(),i.Table=t}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y=function(e,t){return function(){return e.apply(t,arguments)}},b=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};n=typeof exports!="undefined",g=typeof exports!="undefined"&&exports!==null?exports:this,n?(c=g,m=require("underscore")._,t=(e=require("underscore.deferred")).Deferred,v=require("./util")):(m=g._,t=(e=g.jQuery).Deferred,c=g.intermine,v=c.funcutils),u=v.concatMap,l=v.get,o=v.any,p=v.set,a=v.copy,d=v.success,f=v.error,r={},i={},h=function(e,t,n){var r,i,s;return""+(e!=null?e.name:void 0)+"|"+(e!=null?(s=e.service)!=null?s.root:void 0:void 0)+"|"+t+":"+function(){var e;e=[];for(r in n)i=n[r],e.push(""+r+"="+i);return e}()},s=function(){function e(e){var t;this.root=e.root,this.model=e.model,this.descriptors=e.descriptors,this.subclasses=e.subclasses,this.displayName=e.displayName,this.ident=e.ident,this.allDescriptors=y(this.allDescriptors,this),this.getChildNodes=y(this.getChildNodes,this),this.getDisplayName=y(this.getDisplayName,this),this.isa=y(this.isa,this),this.append=y(this.append,this),this.getParent=y(this.getParent,this),this.getEndClass=y(this.getEndClass,this),this.containsCollection=y(this.containsCollection,this),this.isCollection=y(this.isCollection,this),this.isReference=y(this.isReference,this),this.isClass=y(this.isClass,this),this.isAttribute=y(this.isAttribute,this),this.isRoot=y(this.isRoot,this),this.end=m.last(this.descriptors),(t=this.ident)==null&&(this.ident=h(this.model,this,this.subclasses))}return e.prototype.isRoot=function(){return this.descriptors.length===0},e.prototype.isAttribute=function(){return this.end!=null&&this.end.referencedType==null},e.prototype.isClass=function(){return this.isRoot()||this.end.referencedType!=null},e.prototype.isReference=function(){var e;return((e=this.end)!=null?e.referencedType:void 0)!=null},e.prototype.isCollection=function(){var e,t;return(e=(t=this.end)!=null?t.isCollection:void 0)!=null?e:!1},e.prototype.containsCollection=function(){return o(this.descriptors,function(e){return e.isCollection})},e.prototype.getEndClass=function(){var e;return this.model.classes[this.subclasses[this.toString()]||((e=this.end)!=null?e.referencedType:void 0)]||this.root},e.prototype.getParent=function(){var t;if(this.isRoot())throw new Error("Root paths do not have parents");return t={root:this.root,model:this.model,descriptors:m.initial(this.descriptors),subclasses:this.subclasses},new e(t)},e.prototype.append=function(t){var n,r;if(this.isAttribute())throw new Error(""+this+" is an attribute.");r=m.isString(t)?this.getType().fields[t]:t;if(r==null)throw new Error(""+t+" is not a field of "+this.getType());return n={root:this.root,model:this.model,descriptors:this.descriptors.concat(r),subclasses:this.subclasses},new e(n)},e.prototype.isa=function(e){var t,n;return this.isAttribute()?this.getType()===e:(t=e.name?e.name:""+e,n=this.getType(),t===n.name||b.call(this.model.getAncestorsOf(n),t)>=0)},e.prototype.getDisplayName=function(e){var t,n,i,s,o,c=this;return(n=this.displayName)?d(n):((o=this.namePromise)==null&&(this.namePromise=(t=r[this.ident])?d(t):this.model.service==null?f("No service"):(s="model"+u(function(e){return"/"+e.name})(this.allDescriptors()),i=p({format:"json"})(a(this.subclasses)),this.model.service.get(s,i).then(l("display")).done(function(e){var t,n;return(n=r[t=c.ident])!=null?n:r[t]=e}))),this.namePromise.done(e))},e.prototype.getChildNodes=function(){var e,t,n,r,i;r=((n=this.getEndClass())!=null?n.fields:void 0)||{},i=[];for(t in r)e=r[t],i.push(this.append(e));return i},e.prototype.allDescriptors=function(){return[this.root].concat(this.descriptors)},e.prototype.toString=function(){return this.allDescriptors().map(l("name")).join(".")},e.prototype.equals=function(e){return e&&e.ident!=null&&this.ident===e.ident},e.prototype.getType=function(){var e,t;return((e=this.end)!=null?(t=e.type)!=null?t.replace(/java\.lang\./,""):void 0:void 0)||this.getEndClass()},e}(),s.prototype.toPathString=s.prototype.toString,s.parse=function(e,t,n){var r,o,u,a,f,l,c,p,d;return n==null&&(n={}),f=h(e,t,n),(r=i[f])?r:(p=(t+"").split("."),d=o=e.classes[p.shift()],l=d.name,u=function(){var r,i,s,u;u=[];for(r=0,i=p.length;r<i;r++){c=p[r],a=(o!=null?o.fields[c]:void 0)||((s=o=e.classes[n[l]])!=null?s.fields[c]:void 0);if(!a)throw new Error("Could not find "+c+" in "+o+" when parsing "+t);l+="."+c,o=e.classes[a.type||a.referencedType],u.push(a)}return u}(),i[f]=new s({root:d,model:e,descriptors:u,subclasses:n,ident:f}))},s.flushCache=function(){return i={},r={}},c.PathInfo=s}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d=function(e,t){return function(){return e.apply(t,arguments)}},v=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};n=typeof exports!="undefined",h=typeof exports!="undefined"&&exports!==null?exports:this,n?(u=h,c=require("underscore")._,t=(e=require("underscore.deferred")).Deferred,s=require("./table").Table,i=require("./path").PathInfo,l=require("./util").omap):(c=h._,t=(e=h.jQuery).Deferred,u=(p=h.intermine)!=null?p:h.intermine={},s=u.Table,i=u.PathInfo,l=u.funcutils.omap),o=c.flatten,a=c.intersection,f=l(function(e,t){return[e,new s(t)]}),r=function(){function e(e){var t;this.name=e.name,t=e.classes,this.findCommonType=d(this.findCommonType,this),this.findSharedAncestor=d(this.findSharedAncestor,this),this.getAncestorsOf=d(this.getAncestorsOf,this),this.getSubclassesOf=d(this.getSubclassesOf,this),this.getPathInfo=d(this.getPathInfo,this),this.classes=f(t)}return e.prototype.getPathInfo=function(e,t){return i.parse(this,e,t)},e.prototype.getSubclassesOf=function(e){var t,n,r,i,s;n=e&&e.name?e:this.classes[e];if(n==null)throw new Error(""+e+" is not a table");r=[n.name],i=this.classes;for(c in i){t=i[c];if(s=n.name,v.call(t.parents(),s)>=0)r=r.concat(this.getSubclassesOf(t))}return r},e.prototype.getAncestorsOf=function(e){var t,n,r,i,s;n=e&&e.name?e:this.classes[e];if(n==null)throw new Error(""+e+" is not a table");t=n.parents();for(i=0,s=t.length;i<s;i++)r=t[i],t.push(this.getAncestorsOf(r));return o(t)},e.prototype.findSharedAncestor=function(e,t){var n,r;return t===null||e===null?null:e===t?e:(n=this.getAncestorsOf(e),v.call(n,t)>=0?t:(r=this.getAncestorsOf(t),v.call(r,e)>=0?e:a(n,r).shift()))},e.prototype.findCommonType=function(e){return e==null&&(e=[]),e.reduce(this.findSharedAncestor)},e}(),r.prototype.makePath=r.prototype.getPathInfo,r.prototype.findCommonTypeOfMultipleClasses=r.prototype.findCommonType,r.load=function(e){return new r(e)},r.INTEGRAL_TYPES=["int","Integer","long","Long"],r.FRACTIONAL_TYPES=["double","Double","float","Float"],r.NUMERIC_TYPES=r.INTEGRAL_TYPES.concat(r.FRACTIONAL_TYPES),r.BOOLEAN_TYPES=["boolean","Boolean"],u.Model=r}.call(this),function(){var e,t,n,r,i,s,o,u,a=function(e,t){return function(){return e.apply(t,arguments)}};t=typeof exports!="undefined",u=typeof exports!="undefined"&&exports!==null?exports:this,t?(e=require("underscore.deferred").Deferred,o=require("underscore")._,i=require("./util").error,s=u):(o=u._,e=u.jQuery.Deferred,s=u.intermine,i=s.funcutils.error),r=function(e,t,n){return e.service.manageUserPreferences(n,t).done(function(t){return e.preferences=t})},n=function(){function e(e,t){var n;this.service=e,this.username=t.username,this.preferences=t.preferences,this.refresh=a(this.refresh,this),this.clearPreferences=a(this.clearPreferences,this),this.clearPreference=a(this.clearPreference,this),this.setPreferences=a(this.setPreferences,this),this.setPreference=a(this.setPreference,this),this.hasPreferences=this.preferences!=null,(n=this.preferences)==null&&(this.preferences={})}return e.prototype.setPreference=function(e,t){var n;return o.isString(e)?(n={},n[e]=t):t==null?n=e:i("Incorrect arguments to setPreference"),this.setPreferences(n)},e.prototype.setPreferences=function(e){return r(this,e,"POST")},e.prototype.clearPreference=function(e){return r(this,{key:e},"DELETE")},e.prototype.clearPreferences=function(){return r(this,{},"DELETE")},e.prototype.refresh=function(){return r(this,{},"GET")},e}(),s.User=n}.call(this),function(){var e,t,n,r,i,o,u,a,f,l,c,h,p,d,v,m,g=function(e,t){return function(){return e.apply(t,arguments)}},y={}.hasOwnProperty,b=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};t=typeof exports!="undefined",m=typeof exports!="undefined"&&exports!==null?exports:this,t?(v=require("underscore")._,a=require("./util"),c=m):(v=m._,c=m.intermine,a=c.funcutils),f=a.get,h=a.invoke,r=a.REQUIRES_VERSION,d=a.set,u=a.dejoin,o="list/tags",i="lists/shares",e="lists/invitations",p=function(e){return e.substr(0,e.indexOf(":"))==="__folder__"},l=function(e){return s.substr(e.indexOf(":")+1)},n=function(){function t(e,t){var n,r;this.service=t,this.hasTag=g(this.hasTag,this);for(n in e){if(!y.call(e,n))continue;r=e[n],this[n]=r}this.dateCreated=this.dateCreated!=null?new Date(this.dateCreated):null,this.folders=this.tags.filter(p).map(l)}return t.prototype.hasTag=function(e){return b.call(this.tags,e)>=0},t.prototype.query=function(e){return e==null&&(e=["*"]),this.service.query({select:e,from:this.type,where:[[this.type,"IN",this.name]]})},t.prototype.del=function(e){return this.service.makeRequest("DELETE","lists",{name:this.name},e)},t.prototype.fetchTags=function(e){var t=this;return this.service.makeRequest("GET","list/tags",{name:this.name}).pipe(function(e){return e.tags}).done(function(e){return t.tags=e,t.folders.filter(p).map(l)}).done(e)},t.prototype.addTags=function(e,t){var n=this;return this.service.makeRequest("POST","list/tags",{name:this.name,tags:e}).pipe(function(e){return e.tags}).done(function(e){return n.tags=e,n.folders.filter(p).map(l)}).done(t)},t.prototype.removeTags=function(e,t){var n=this;return this.service.makeRequest("DELETE","list/tags",{name:this.name,tags:e}).pipe(function(e){return e.tags}).done(function(e){return n.tags=e,n.folders.filter(p).map(l)}).done(t)},t.prototype.contents=function(e){return this.query().pipe(u).pipe(h("records")).done(e)},t.prototype.rename=function(e,t){var n=this;return this.service.post("lists/rename",{oldname:this.name,newname:e}).pipe(f("listName")).done(function(e){return n.name=e}).pipe(this.service.fetchList).done(t)},t.prototype.copy=function(e,t){var n,r,i,s,o,u,a,l=this;return e==null&&(e={}),t==null&&(t=function(){}),arguments.length===1&&v.isFunction(e)&&(o=[{},e],e=o[0],t=o[1]),v.isString(e)&&(e={name:""+e}),r=n=(u=e.name)!=null?u:""+this.name+"_copy",s=this.tags.concat((a=e.tags)!=null?a:[]),i=this.query(["id"]),this.service.fetchLists().pipe(h("map",f("name"))).pipe(function(e){var o;o=1;while(b.call(e,r)>=0)r=""+n+"-"+o++;return i.pipe(h("saveAsList",{name:r,tags:s,description:l.description})).done(t)})},t.prototype.enrichment=function(e,t){return this.service.enrichment(d({list:this.name})(e),t)},t.prototype.shareWithUser=function(e,t){return this.service.post(i,{list:this.name,"with":e}).done(t)},t.prototype.inviteUserToShare=function(t,n,r){return n==null&&(n=!0),r==null&&(r=function(){}),this.service.post(e,{list:this.name,to:t,notify:!!n}).done(r)},t}(),c.List=n}.call(this),function(){var e,t,n,r,i,s,o,u=function(e,t){return function(){return e.apply(t,arguments)}};n=typeof exports!="undefined",o=typeof exports!="undefined"&&exports!==null?exports:this,n?(e=require("underscore.deferred").Deferred,r=require("./util"),s=o):(e=o.jQuery.Deferred,s=o.intermine,r=s.funcutils),i=r.get,t=function(){function t(e,t){this.uid=e,this.service=t,this.del=u(this.del,this),this.fetchResults=u(this.fetchResults,this),this.fetchErrorMessage=u(this.fetchErrorMessage,this),this.fetchStatus=u(this.fetchStatus,this)}return t.prototype.fetchStatus=function(e){return this.service.get("ids/"+this.uid+"/status").pipe(i("status")).done(e)},t.prototype.fetchErrorMessage=function(e){return this.service.get("ids/"+this.uid+"/status").pipe(i("message")).done(e)},t.prototype.fetchResults=function(e){return this.service.get("ids/"+this.uid+"/result").pipe(i("results")).done(e)},t.prototype.del=function(e){return this.service.makeRequest("DELETE","ids/"+this.uid,{},e)},t.prototype.poll=function(t,n,r){var i,s,o=this;return s=e().done(t).fail(n).progress(r),i=this.fetchStatus(),i.fail(s.reject),i.done(function(e){s.notify(e);switch(e){case"SUCCESS":return o.fetchResults().then(s.resolve,s.reject);case"ERROR":return o.fetchErrorMessage().then(s.reject,s.reject);default:return o.poll(s.resolve,s.reject,s.notify)}}),s.promise()},t}(),t.create=function(e){return function(n){return new t(n,e)}},s.IDResolutionJob=t}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},X=function(e,t){return function(){return e.apply(t,arguments)}},V=[].slice;i=typeof exports!="undefined",P=typeof exports!="undefined"&&exports!==null?exports:this,i?(E=P,D=require("underscore")._,r=(e=require("underscore.deferred")).Deferred,M=require("querystring").stringify,R=require("./util"),L=R.partition,m=R.fold,O=R.take,h=R.concatMap,b=R.id,g=R.get):(D=P._,T=P.jQuery,E=P.intermine,U=E.funcutils,L=U.partition,m=U.fold,O=U.take,h=U.concatMap,b=U.id,g=U.get,r=(e=T).Deferred,M=function(e){return T.param(e,!0)}),y=function(e){var t;t=D.isString(e)?o.OP_DICT[e.toLowerCase()]:null;if(!t)throw new Error("Illegal constraint operator: "+e);return t},t=["path","op","code"],a=t.concat(["value","extraValue"]),u=["rowByRow","eachRow","recordByRecord","eachRecord","records","rows","table","tableRows"],s=function(e){return D.compose(e.fetchList,g("listName"))},n=[null,"A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],p=function(e){return e.substr(e.indexOf("."))},c=function(e){return"<value>"+D.escape(e)+"</value>"},f=function(e,t){var n,r;return function(){var i;i=[];for(n in e)r=e[n],W.call(t,n)>=0&&i.push(""+n+'="'+D.escape(r)+'" ');return i}().join("")},k=function(e){return"<constraint "+f(e,t)+"/>"},_=function(e){return"<constraint "+f(e,["path","type"])+"/>"},A=function(e){return"<constraint "+f(e,a)+"/>"},C=function(e){return"<constraint "+f(e,t)+">"+h(c)(e.values)+"</constraint>"},w=function(e){return"<constraint "+f(e,t)+'ids="'+e.ids.join(",")+'"/>'},l=function(e){var t;return e.values!=null?C(e):e.ids!=null?w(e):e.op==null?_(e):(t=e.op,W.call(o.NULL_OPS,t)>=0)?k(e):A(e)},d=function(e,t){return"Did not remove a single constraint. original = "+e+", reduced = "+t},x=function(e,t){var n,r,i,s,u,a;n={path:e};if(t===null)n.op="IS NULL";else if(D.isArray(t))n.op="ONE OF",n.values=t;else if(D.isString(t)||D.isNumber(t))(a=typeof t.toUpperCase=="function"?t.toUpperCase():void 0,W.call(o.NULL_OPS,a)>=0)?n.op=t:(n.op="=",n.value=t);else{i=function(){var e;e=[];for(r in t)u=t[r],e.push(r);return e}();if(W.call(i,"isa")>=0)D.isArray(t.isa)?(n.op=r,n.values=t.isa):n.type=t.isa;else{W.call(i,"extraValue")>=0&&(n.extraValue=t.extraValue);for(r in t){s=t[r];if(r==="extraValue")continue;n.op=r,D.isArray(s)?n.values=s:n.value=s}}}return n},S=function(e){var t,n,r,i;return e=e.slice(),n={path:e.shift()},e.length===1?(t=e[0],(i=typeof t.toUpperCase=="function"?t.toUpperCase():void 0,W.call(o.NULL_OPS,i)>=0)?n.op=t:n.type=t):e.length>=2&&(n.op=e[0],r=e[1],D.isArray(r)?n.values=r:n.value=r,e.length===3&&(n.extraValue=e[2])),n},o=function(){function i(e,n){this.addConstraint=X(this.addConstraint,this),this.expandStar=X(this.expandStar,this),this.adjustPath=X(this.adjustPath,this),this.select=X(this.select,this);var r,i,s,o,u,a,f,l,c,h=this;D.defaults(this,{constraints:[],views:[],joins:{},constraintLogic:"",sortOrder:""}),e==null&&(e={}),this.displayNames=D.extend({},(i=(s=e.displayNames)!=null?s:e.aliases)!=null?i:{}),this.service=n!=null?n:{},this.model=(o=e.model)!=null?o:{},this.summaryFields=(u=e.summaryFields)!=null?u:{},this.root=(a=e.root)!=null?a:e.from,this.maxRows=(f=(l=e.size)!=null?l:e.limit)!=null?f:e.maxRows,this.start=(c=(r=e.start)!=null?r:e.offset)!=null?c:0,this.select(e.views||e.view||e.select||[]),this.addConstraints(e.constraints||e.where||[]),this.addJoins(e.joins||e.join||[]),this.orderBy(e.sortOrder||e.orderBy||[]),e.constraintLogic!=null&&(this.constraintLogic=e.constraintLogic),t=function(e,n){var r,i,s;return r=h.getPathInfo(e).getEndClass(),s=[e],i=r&&n>0?D.flatten(D.map(r.fields,function(r){return t(""+e+"."+r.name,n-1)})):[],D.flatten(s.concat(i))}}var e,t;return i.JOIN_STYLES=["INNER","OUTER"],i.BIO_FORMATS=["gff3","fasta","bed"],i.NULL_OPS=["IS NULL","IS NOT NULL"],i.ATTRIBUTE_VALUE_OPS=["=","!=",">",">=","<","<=","CONTAINS","LIKE","NOT LIKE"],i.MULTIVALUE_OPS=["ONE OF","NONE OF"],i.TERNARY_OPS=["LOOKUP"],i.LOOP_OPS=["=","!="],i.LIST_OPS=["IN","NOT IN"],i.OP_DICT={"=":"=","==":"=",eq:"=","!=":"!=",ne:"!=",">":">",gt:">",">=":">=",ge:">=","<":"<",lt:"<","<=":"<=",le:"<=",contains:"CONTAINS",CONTAINS:"CONTAINS",like:"LIKE",LIKE:"LIKE","not like":"NOT LIKE","NOT LIKE":"NOT LIKE",lookup:"LOOKUP","IS NULL":"IS NULL","is null":"IS NULL","IS NOT NULL":"IS NOT NULL","is not null":"IS NOT NULL","ONE OF":"ONE OF","one of":"ONE OF","NONE OF":"NONE OF","none of":"NONE OF","in":"IN","not in":"NOT IN",IN:"IN","NOT IN":"NOT IN",WITHIN:"WITHIN",within:"WITHIN",OVERLAPS:"OVERLAPS",overlaps:"OVERLAPS",ISA:"ISA",isa:"ISA"},t=function(){},i.prototype.on=function(e,t,n){var r,i,s,o,u,a,f;e=e.split(/\s+/),r=(u=this._callbacks)!=null?u:this._callbacks={};while(i=e.shift())s=(a=r[i])!=null?a:r[i]={},o=(f=s.tail)!=null?f:s.tail=s.next={},o.callback=t,o.context=n,s.tail=o.next={};return this},i.prototype.bind=function(){var e;return e=1<=arguments.length?V.call(arguments,0):[],this.on.apply(this,e)},i.prototype.trigger=function(){var e,t,n,r,i,s,o,u;i=arguments[0],o=2<=arguments.length?V.call(arguments,1):[],n=this._callbacks;if(!n)return this;e=n.all,(i=i.split(/\s+/)).push(null);while(r=i.shift()){e&&i.push({next:e.next,tail:e.tail,event:r});if(!(s=n[r]))continue;i.push({next:s.next,tail:s.tail})}while(s=i.pop()){u=s.tail,t=s.event?[s.event].concat(o):o;while((s=s.next)!==u)s.callback.apply(s.context||this,t)}return this},i.prototype.removeFromSelect=function(e){var t,n,r,i;return e=D.isString(e)?[e]:e||[],t=D.compose(this.expandStar,this.adjustPath),e=D.flatten(function(){var n,i,s;s=[];for(n=0,i=e.length;n<i;n++)r=e[n],s.push(t(r));return s}()),this.sortOrder=function(){var t,r,i,s,o;i=this.sortOrder,o=[];for(t=0,r=i.length;t<r;t++)n=i[t],(s=n.path,W.call(e,s)>=0)||o.push(n);return o}.call(this),this.views=function(){var t,n,r,s;r=this.views,s=[];for(t=0,n=r.length;t<n;t++)i=r[t],W.call(e,i)>=0||s.push(i);return s}.call(this),this.trigger("remove:view",e),this.trigger("change:views",this.views)},i.prototype.removeConstraint=function(e,t){var n,r,i,s;t==null&&(t=!1),i=this.constraints,r=typeof e=="string"?function(t){return t.code===e}:function(t){var n,r;return t.path===e.path&&t.op===e.op&&t.value===e.value&&t.extraValue===e.extraValue&&e.type===t.type&&((n=t.values)!=null?n.join("%%"):void 0)===((r=e.values)!=null?r.join("%%"):void 0)},s=function(){var e,t,s;s=[];for(e=0,t=i.length;e<t;e++)n=i[e],r(n)||s.push(n);return s}();if(s.length!==i.length-1)throw new Error(d(i,s));this.constraints=s;if(!t)return this.trigger("change:constraints"),this.trigger("removed:constraints",D.difference(i,s))},i.prototype.addToSelect=function(e){var t,n,r,i,s;e=D.isString(e)?[e]:e||[],n=D.map(e,D.compose(this.expandStar,this.adjustPath)),s=D.flatten([n]);for(r=0,i=s.length;r<i;r++)t=s[r],this.views.push(t);return this.trigger("add:view change:views",n)},i.prototype.select=function(e){return this.views=[],this.addToSelect(e),this},i.prototype.adjustPath=function(e){return e=e&&e.name?e.name:""+e,this.root!=null?e.match("^"+this.root)||(e=this.root+"."+e):this.root=e.split(".")[0],e},i.prototype.getPossiblePaths=function(e){var n,r,i;return e==null&&(e=3),(r=this._possiblePaths)==null&&(this._possiblePaths={}),(i=(n=this._possiblePaths)[e])!=null?i:n[e]=t(this.root,e)},i.prototype.getPathInfo=function(e){var t,n,r;return t=this.adjustPath(e),n=(r=this.model)!=null?typeof r.getPathInfo=="function"?r.getPathInfo(t,this.getSubclasses()):void 0:void 0,n&&t in this.displayNames&&(n.displayName=this.displayNames[t]),n},i.prototype.makePath=i.prototype.getPathInfo,i.prototype.getSubclasses=function(){return m({},function(e,t){return t.type!=null&&(e[t.path]=t.type),e})(this.constraints)},i.prototype.getType=function(e){return this.getPathInfo(e).getType()},i.prototype.getViewNodes=function(){var e,t=this;return e=function(e){return t.getPathInfo(e).getParent()},D.uniq(D.map(this.views,e),!1,function(e){return e.toPathString()})},i.prototype.isInView=function(e){var t,n,r;t=this.getPathInfo(e);if(!t)throw new Error("Invalid path: "+e);return t.isAttribute()?(r=t.toString(),W.call(this.views,r)>=0):(n=t.toString(),D.any(this.getViewNodes(),function(e){return e.toString()===n}))},i.prototype.isConstrained=function(e,t){var n,r,i=this;t==null&&(t=!1),n=this.getPathInfo(e);if(!n)throw new Error("Invalid path: "+e);return r=function(e){return e.op!=null&&e.path===n.toString()},!n.isAttribute()&&t&&(r=function(e){return e.op!=null&&(e.path===n.toString()||n.equals(i.getPathInfo(e.path).getParent()))}),D.any(this.constraints,r)},i.prototype.canHaveMultipleValues=function(e){return this.getPathInfo(e).containsCollection()},i.prototype.getQueryNodes=function(){var e,t,n=this;return t=this.getViewNodes(),e=D.map(this.constraints,function(e){var t;return t=n.getPathInfo(e.path),t.isAttribute()?t.getParent():t}),D.uniq(t.concat(e),!1,function(e){return e.toPathString()})},i.prototype.isInQuery=function(e){var t,n;return t=this.getPathInfo(e),t?(n=t.toPathString(),D.any(D.union(this.views,D.pluck(this.constraints,"path")),function(e){return e.indexOf(n)===0})):!0},i.prototype.isRelevant=function(e){var t,n,r;return n=this.getPathInfo(e),n.isAttribute()&&(n=n.getParent()),r=n.toString(),t=this.getQueryNodes(),D.any(t,function(e){return e.toPathString()===r})},i.prototype.expandStar=function(e){var t,n,r,i,s;if(/\*$/.test(e)){s=e.substr(0,e.lastIndexOf(".")),n=function(e){return s+e},t=this.getType(s);if(/\.\*$/.test(e)&&t&&this.summaryFields[t.name])return r=D.compose(n,p),function(){var e,n,s,o;s=this.summaryFields[t.name],o=[];for(e=0,n=s.length;e<n;e++)i=s[e],this.hasView(i)||o.push(r(i));return o}.call(this);if(/\.\*\*$/.test(e))return r=D.compose(n,function(e){return"."+e.name}),D.uniq(D.union(this.expandStar(s+".*"),D.map(t.attributes,r)))}return e},i.prototype.isOuterJoin=function(e){return this.joins[this.adjustPath(e)]==="OUTER"},i.prototype.hasView=function(e){return this.views&&D.include(this.views,this.adjustPath(e))},i.prototype.count=function(e){if(this.service.count)return this.service.count(this,e);throw new Error("This query has no service with count functionality attached.")},i.prototype.appendToList=function(e,t){var n,r,i,o;return n=e&&e.name?e.name:""+e,i=this.makeListQuery(),r={listName:n,query:i.toXML()},o=(e!=null?e.name:void 0)?function(t){return e.size=t.size}:function(){},this.service.post("query/append/tolist",r).pipe(s(this.service)).done(t,o)},i.prototype.makeListQuery=function(){var e,t,n,r,i;t=this.clone(),(t.views.length!==1||t.views[0]===null||!t.views[0].match(/\.id$/))&&t.select(["id"]),i=this.getViewNodes();for(n=0,r=i.length;n<r;n++)e=i[n],this.isOuterJoined(e)||!t.isInView(e||t.isConstrained(e))&&e.getEndClass().fields.id!=null&&t.addConstraint([e.append("id"),"IS NOT NULL"]);return t},i.prototype.saveAsList=function(e,t){var n,r;return r=this.makeListQuery(),n=D.clone(e),n.listName=n.listName||n.name,n.query=r.toXML(),e.tags&&(n.tags=e.tags.join(";")),this.service.post("query/tolist",n).pipe(s(this.service)).done(t)},i.prototype.summarise=function(e,t,n){return this.filterSummary(e,"",t,n)},i.prototype.summarize=function(){var e;return e=1<=arguments.length?V.call(arguments,0):[],this.summarise.apply(this,e)},i.prototype.filterSummary=function(e,t,n,i){var s,o,u,a;return i==null&&(i=function(){}),D.isFunction(n)&&(a=[n,null],i=a[0],n=a[1]),e=this.adjustPath(e),u=this.clone(),D.include(u.views,e)||u.views.push(e),o={query:u.toXML(),summaryPath:e,format:"jsonrows"},n&&(o.size=n),t&&(o.filterTerm=t),s=function(e){return r(function(){var t,n,r;return t=e.results.map(function(e){return e.count=parseInt(e.count,10),e}),n={uniqueValues:e.uniqueValues},((r=t[0])!=null?r.max:void 0)!=null&&D.extend(n,t[0]),this.resolve(t,n,e.filteredCount)})},this.service.post("query/results",o).pipe(s).done(i)},i.prototype.clone=function(e){var t;return t=new i(this,this.service),e?t._callbacks=this._callbacks:t._callbacks={},t},i.prototype.next=function(){var e;return e=this.clone(),this.maxRows&&(e.start=this.start+this.maxRows),e},i.prototype.previous=function(){var e;return e=this.clone(),this.maxRows?e.start=this.start-this.maxRows:e.start=0,e},i.prototype.getSortDirection=function(e){var t,n,r,i,s;e=this.adjustPath(e),s=this.sortOrder;for(r=0,i=s.length;r<i;r++)n=s[r],n.path===e&&(t=n.direction);return t},i.prototype.isOuterJoined=function(e){return e=this.adjustPath(e),D.any(this.joins,function(t,n){return t==="OUTER"&&e.indexOf(n)===0})},i.prototype.getOuterJoin=function(e){var t,n=this;return e=this.adjustPath(e),t=D.sortBy(D.keys(this.joins),g("length")).reverse(),D.find(t,function(t){return n.joins[t]==="OUTER"&&e.indexOf(t)===0})},i.prototype._parse_sort_order=function(e){var t,n,r;return n=e,D.isString(e)?n={path:e,direction:"ASC"}:e.path==null&&(t=D.keys(e)[0],r=D.values(e)[0],n={path:t,direction:r}),n.path=this.adjustPath(n.path),n.direction=n.direction.toUpperCase(),n},i.prototype.addOrSetSortOrder=function(e){var t,n,r,i,s;e=this._parse_sort_order(e),t=this.getSortDirection(e.path);if(t==null)return this.addSortOrder(e);if(t!==e.direction){s=this.sortOrder;for(r=0,i=s.length;r<i;r++)n=s[r],n.path===e.path&&(n.direction=e.direction);return this.trigger("change:sortorder",this.sortOrder)}},i.prototype.addSortOrder=function(e){return this.sortOrder.push(this._parse_sort_order(e)),this.trigger("add:sortorder",e),this.trigger("change:sortorder",this.sortOrder)},i.prototype.orderBy=function(e){var t,n,r;this.sortOrder=[];for(n=0,r=e.length;n<r;n++)t=e[n],this.addSortOrder(t);return this.trigger("set:sortorder",this.sortOrder)},i.prototype.addJoins=function(e){var t,n,r,i,s,o,u;if(D.isArray(e)){o=[];for(i=0,s=e.length;i<s;i++)t=e[i],o.push(this.addJoin(t));return o}u=[];for(n in e)r=e[n],u.push(this.addJoin({path:n,style:r}));return u},i.prototype.addJoin=function(e){var t,n,r;D.isString(e)&&(e={path:e,style:"OUTER"}),e.path=this.adjustPath(e.path),e.style=(t=(n=e.style)!=null?n.toUpperCase():void 0)!=null?t:e.style;if(r=e.style,W.call(i.JOIN_STYLES,r)<0)throw new Error("Invalid join style: "+e.style);return this.joins[e.path]=e.style,this.trigger("set:join",e.path,e.style)},i.prototype.setJoinStyle=function(e,t){return t==null&&(t="OUTER"),e=this.adjustPath(e),t=t.toUpperCase(),this.joins[e]!==t&&(this.joins[e]=t,this.trigger("change:joins",{path:e,style:t})),this},i.prototype.addConstraints=function(e){var t,n,r,i,s,o,u=this;this.__silent__=!0;if(D.isArray(e))for(s=0,o=e.length;s<o;s++)t=e[s],this.addConstraint(t);else{i=function(e,t){return u.addConstraint(x(e,t))};for(r in e)n=e[r],i(r,n)}return this.__silent__=!1,this.trigger("add:constraint"),this.trigger("change:constraints")},i.prototype.addConstraint=function(e){D.isArray(e)&&(e=S(e)),e.path=this.adjustPath(e.path);if(e.type==null)try{e.op=y(e.op)}catch(t){throw new Error("Illegal operator: "+e.op)}return this.constraints.push(e),this.constraintLogic!=null&&this.constraintLogic!==""&&(this.constraintLogic="("+this.constraintLogic+") and "+n[this.constraints.length]),this.__silent__||(this.trigger("add:constraint",e),this.trigger("change:constraints")),this},i.prototype.getSorting=function(){var e;return function(){var t,n,r,i;r=this.sortOrder,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(""+e.path+" "+e.direction);return i}.call(this).join(" ")},i.prototype.getConstraintXML=function(){return this.constraints.length?h(l)(h(b)(L(function(e){return e.type!=null})(this.constraints))):""},i.prototype.getJoinXML=function(){var e,t,n;return n=function(){var n,r;n=this.joins,r=[];for(e in n)t=n[e],this.isInQuery(e)&&t==="OUTER"&&r.push('<join path="'+e+'" style="OUTER"/>');return r}.call(this),n.join("")},i.prototype.toXML=function(){var e,t,n,r;return e={model:this.model.name,view:this.views.join(" "),sortOrder:this.getSorting(),constraintLogic:this.constraintLogic},this.name!=null&&(e.name=this.name),t=function(){var t;t=[];for(n in e)r=e[n],r&&t.push(n+'="'+r+'"');return t}().join(" "),"<query "+t+" >"+this.getJoinXML()+this.getConstraintXML()+"</query>"},i.prototype.fetchCode=function(e,t){var n;return n={query:this.toXML(),lang:e},this.service.get("query/code",n).pipe(this.service.VERIFIER).pipe(g("code")).done(t)},i.prototype.save=function(e,t){var n,r=this;return e!=null&&(this.name=e),n={data:this.toXML(),contentType:"application/xml; charset=UTF-8",url:this.service.root+"query",type:"POST",dataType:"json"},this.service.doReq(n).pipe(this.service.VERIFIER).pipe(g("name")).done(t,function(e){return r.name=e})},i.prototype.getCodeURI=function(e){var t,n;return t={query:this.toXML(),lang:e,format:"text"},((n=this.service)!=null?n.token:void 0)!=null&&(t.token=this.service.token),""+this.service.root+"query/code?"+M(t)},i.prototype.getExportURI=function(e){var t,n;return e==null&&(e="tab"),W.call(i.BIO_FORMATS,e)>=0?this["get"+e.toUpperCase()+"URI"]():(t={query:this.toXML(),format:e},((n=this.service)!=null?n.token:void 0)!=null&&(t.token=this.service.token),""+this.service.root+"query/results?"+M(t))},e=function(e){return e.append("primaryIdentifier").toString()},i.prototype.__bio_req=function(t,n){var r,i;return i=this.makeListQuery(),r=function(e){return D.any(t,function(t){return e.isa(t)})},i.views=O(n)(function(){var t,i,s,o;s=this.getViewNodes(),o=[];for(t=0,i=s.length;t<i;t++)n=s[t],r(n)&&o.push(e(n));return o}.call(this)),{query:i.toXML(),format:"text"}},i.prototype._fasta_req=function(){return this.__bio_req(["SequenceFeature","Protein"],1)},i.prototype._gff3_req=function(){return this.__bio_req(["SequenceFeature"])},i.prototype._bed_req=i.prototype._gff3_req,i}(),o.ATTRIBUTE_OPS=D.union(o.ATTRIBUTE_VALUE_OPS,o.MULTIVALUE_OPS,o.NULL_OPS),o.REFERENCE_OPS=D.union(o.TERNARY_OPS,o.LOOP_OPS,o.LIST_OPS),z=o.BIO_FORMATS,H=function(e){var t,n,r;return n="_"+e+"_req",t="get"+e.toUpperCase(),r=t+"URI",o.prototype[t]=function(t,r){var i,s,o;return t==null&&(t={}),r==null&&(r=function(){}),D.isFunction(t)&&(o=[{},t],t=o[0],r=o[1]),(t!=null?t.view:void 0)!=null&&(t.view=function(){var e,n,r,i;r=t.view,i=[];for(e=0,n=r.length;e<n;e++)s=r[e],i.push(this.getPathInfo(s).toString());return i}.call(this)),i=D.extend(this[n](),t),this.service.post("query/results/"+e,i).done(r)},o.prototype[r]=function(t,r){var i,s,o;return t==null&&(t={}),D.isFunction(t)&&(o=[{},t],t=o[0],r=o[1]),(t!=null?t.view:void 0)!=null&&(t.view=function(){var e,n,r,i;r=t.view,i=[];for(e=0,n=r.length;e<n;e++)s=r[e],i.push(this.getPathInfo(s).toString());return i}.call(this)),i=D.extend(this[n](),t),this.service.token!=null&&(i.token=this.service.token),""+this.service.root+"query/results/"+e+"?"+M(i)}};for(j=0,I=z.length;j<I;j++)v=z[j],H(v);B=function(e){return function(){var t,n,r,i;n=arguments[0],t=2<=arguments.length?V.call(arguments,1):[];if(this.service[e])return n==null?n={}:D.isFunction(n)&&(n={},t=function(){var e,t,n;n=[];for(e=0,t=arguments.length;e<t;e++)r=arguments[e],n.push(r);return n}.apply(this,arguments)),D.defaults(n,{start:this.start,size:this.maxRows}),(i=this.service)[e].apply(i,[this,n].concat(V.call(t)));throw new Error("Service does not provide '"+e+"'.")}};for(F=0,q=u.length;F<q;F++)N=u[F],o.prototype[N]=B(N);E.Query=o}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt=function(e,t){return function(){return e.apply(t,arguments)}},nt=[].slice;f=typeof exports!="undefined",Z=typeof exports!="undefined"&&exports!==null?exports:this,f?(Y=require("underscore")._,r=(e=require("underscore.deferred")).Deferred,m=require("./model").Model,E=require("./query").Query,p=require("./lists").List,M=require("./user").User,a=require("./id-resolution-job").IDResolutionJob,U=require("./util"),G=require("querystring").stringify,X=require("./http"),V=exports):(Y=Z._,J=Z.jQuery,V=Z.intermine,r=(e=J).Deferred,G=function(e){return J.param(e,!0)},m=V.Model,E=V.Query,p=V.List,M=V.User,a=V.IDResolutionJob,U=V.funcutils,X=V.http),F=U.curry,R=U.fold,z=U.get,K=U.set,$=U.invoke,Q=U.success,q=U.error,S=U.REQUIRES_VERSION,I=U.dejoin,_={},d={},C={},H={},n="http://",D="version",A="templates",l="lists",v="model",N="summaryfields",b="query/results",w="search",B="widgets",i="list/enrichment",j="listswithobject",c={union:"lists/union",intersection:"lists/intersect",difference:"lists/diff"},x="lists/subtract",P="user/whoami",L=b+"/tablerows",y="user/preferences",g="path/values",u=function(e){return e},s=/^https?:\/\//i,o=/service\/?$/i,T="/service/",t=function(e){var t,n;if(f&&e.stack!=null)return console.error(e.stack);t=(e!=null?e.stack:void 0)?[e.stack]:arguments;if(typeof console!="undefined"&&console!==null)return(n=console.error||console.log)!=null?n.apply(console,t):void 0},et=function(e,t,n,r,i){var s,o,u,a=this;return s=(u=this[e])!=null?u:this[e]=this.useCache&&(o=t[this.root])?Q(o):this.get(n).pipe(z(r)).done(function(e){return t[a.root]=e}),s.done(i)},W=function(e){return function(t){return r(function(){var n;return(n=Y.find(t,function(t){return t.name===e}))?this.resolve(n):this.reject('List "'+e+'" not found among: '+t.map(z("name")))})}},h=function(e,t){return t==null&&(t="listName"),Y.compose(e.fetchList,z(t))},O=function(e){var t,n,r,i,s,o;e==null&&(e=[]),i=Y.isArray(e)?e:[e],o=[];for(n=0,r=i.length;n<r;n++)t=i[n],o.push((s=t.name)!=null?s:t);return o},k=function(){function u(e){var r,i,u,a,l=this;this.root=e.root,this.token=e.token,this.errorHandler=e.errorHandler,this.DEBUG=e.DEBUG,this.help=e.help,i=e.noCache,this.createList=tt(this.createList,this),this.resolveIds=tt(this.resolveIds,this),this.query=tt(this.query,this),this.fetchWidgetMap=tt(this.fetchWidgetMap,this),this.fetchWidgets=tt(this.fetchWidgets,this),this.complement=tt(this.complement,this),this.fetchListsContaining=tt(this.fetchListsContaining,this),this.fetchList=tt(this.fetchList,this),this.findLists=tt(this.findLists,this),this.fetchLists=tt(this.fetchLists,this),this.fetchTemplates=tt(this.fetchTemplates,this),this.tableRows=tt(this.tableRows,this),this.rows=tt(this.rows,this),this.records=tt(this.records,this),this.table=tt(this.table,this),this.pathValues=tt(this.pathValues,this),this.values=tt(this.values,this),this.fetchUser=tt(this.fetchUser,this),this.whoami=tt(this.whoami,this),this.findById=tt(this.findById,this),this.count=tt(this.count,this),this.enrichment=tt(this.enrichment,this);if(this.root==null)throw new Error("No service root provided. This is required");s.test(this.root)||(this.root=n+this.root),o.test(this.root)||(this.root=this.root+T),this.root=this.root.replace(/ice$/,"ice/"),(u=this.errorHandler)==null&&(this.errorHandler=t),(a=this.help)==null&&(this.help="no.help.available@dev.null"),this.useCache=!i,r=f?"":location.protocol+"//"+location.host,this.getFormat=function(e){return e==null&&(e="json"),!/jsonp/.test(e)&&!f&&!J.support.cors&&r.substring(0,l.root.length)!==l.root?e.replace("json","jsonp"):e}}return u.prototype.post=function(e,t){return t==null&&(t={}),this.makeRequest("POST",e,t)},u.prototype.get=function(e,t){return this.makeRequest("GET",e,t)},u.prototype.makeRequest=function(e,t,n,r,i){var s,o,u,a,f;return e==null&&(e="GET"),t==null&&(t=""),n==null&&(n={}),r==null&&(r=function(){}),i==null&&(i=!1),Y.isArray(r)&&(a=r,r=a[0],s=a[1]),Y.isArray(n)&&(n=Y.foldl(n,function(e,t){var n,r;return n=t[0],r=t[1],e[n]=r,e},{})),u=this.root+t,s==null&&(s=this.errorHandler),this.token&&(n.token=this.token),n.format=this.getFormat(n.format),/jsonp/.test(n.format)&&(n.method=e,e="GET",u+="?callback=?"),X.supports(e)||(f=[e,X.getMethod(e)],n.method=f[0],e=f[1]),e==="DELETE"&&(u+="?"+G(n)),o={data:n,dataType:n.format,success:r,error:s,url:u,type:e},X.doReq(o,i)},u.prototype.enrichment=function(e,t){var n=this;return S(this,8,function(){return n.get(i,Y.defaults({},e,{maxp:.05,correction:"Holm-Bonferroni"})).pipe(z("results")).done(t)})},u.prototype.search=function(e,t){var n=this;return e==null&&(e={}),t==null&&(t=function(){}),S(this,9,function(){var r,i,s,o,u,a;Y.isFunction(e)&&(u=[e,{}],t=u[0],e=u[1]),Y.isString(e)&&(e={q:e}),s=Y.defaults({},e,{q:""}),delete s.facets;if(e.facets){a=e.facets;for(r in a)o=a[r],s["facet_"+r]=o}return i=function(e){return Q(e.results,e.facets)},n.post(w,s).pipe(i).done(t)})},u.prototype.count=function(e,t){var n,r;return t==null&&(t=function(){}),e?e.toPathString!=null?(n=e.isClass()?e.append("id"):e,this.pathValues(n,"count").done(t)):e.toXML!=null?(r={query:e.toXML(),format:"jsoncount"},this.post(b,r).pipe(z("count")).done(t)):Y.isString(e)?this.fetchModel().pipe($("makePath",e.replace(/\.\*$/,".id"))).pipe(this.count).done(t):this.query(e).pipe(this.count).done(t):q("Not enough arguments")},u.prototype.findById=function(e,t,n){return this.query({from:e,select:["**"],where:{id:t}}).pipe(I).pipe($("records")).pipe(z(0)).done(n)},u.prototype.find=function(e,t,n){return this.query({from:e,select:["**"],where:[[e,"LOOKUP",t]]}).pipe(I).pipe($("records")).done(n)},u.prototype.whoami=function(e){var t=this;return S(this,9,function(){return t.get(P).pipe(z("user")).pipe(function(e){return new M(t,e)}).done(e)})},u.prototype.fetchUser=function(){var e;return e=1<=arguments.length?nt.call(arguments,0):[],this.whoami.apply(this,e)},u.prototype.values=function(e,t,n){var r=this;return t==null&&(t={}),n==null&&(n=function(){}),S(this,6,function(){try{return r.fetchModel().pipe($("makePath",e,e.subclasses||t)).pipe(r.pathValues).done(n)}catch(i){return q(i)}})},u.prototype.pathValues=function(e,t){var n,r;return t!=="count"&&(t="results"),n=t==="count"?"jsoncount":"json",r={format:n,path:e.toString(),typeConstraints:JSON.stringify(e.subclasses)},this.post(g,r).pipe(z(t))},u.prototype.doPagedRequest=function(e,t,n,r,i){var s,o=this;return n==null&&(n={}),e.toXML!=null?(s=Y.defaults({},{query:e.toXML(),format:r},n),this.post(t,s).pipe(function(e){return Q(e.results,e)}).done(i)):this.query(e).pipe(function(e){return o.doPagedRequest(e,t,n,r,i)})},u.prototype.table=function(e,t,n){return this.doPagedRequest(e,b,t,"jsontable",n)},u.prototype.records=function(e,t,n){return this.doPagedRequest(e,b,t,"jsonobjects",n)},u.prototype.rows=function(e,t,n){return this.doPagedRequest(e,b,t,"json",n)},u.prototype.tableRows=function(e,t,n){return this.doPagedRequest(e,L,t,"json",n)},u.prototype.fetchTemplates=function(e){return this.get(A).pipe(z("templates")).done(e)},u.prototype.fetchLists=function(e){return this.findLists("",e)},u.prototype.findLists=function(e,t){var n=this;return e==null&&(e=""),t==null&&(t=function(){}),this.fetchVersion().pipe(function(r){var i;return e&&r<13?q("Finding lists by name on the server requires version 13. This is only "+r):(i=function(e){var t,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)t=e[r],s.push(new p(t,n));return s},n.get(l,{name:e}).pipe(z("lists")).pipe(i).done(t))})},u.prototype.fetchList=function(e,t){var n=this;return this.fetchVersion().pipe(function(r){return r<13?n.findLists().pipe(W(e)).done(t):n.findLists(e).pipe(z(0)).done(t)})},u.prototype.fetchListsContaining=function(e,t){var n,r=this;return n=function(e){var t,n,i,s;s=[];for(n=0,i=e.length;n<i;n++)t=e[n],s.push(new p(t,r));return s},this.get(j,e).pipe(z("lists")).pipe(n).done(t)},u.prototype.combineLists=function(e,t,n){var r,i;return r=Y.pick(t,"name","description"),(i=r.description)==null&&(r.description=""+e+" of "+t.lists.join(", ")),r.tags=(t.tags||[]).join(";"),r.lists=(t.lists||[]).join(";"),this.get(c[e],r).pipe(h(this)).done(n)},u.prototype.merge=function(){return this.combineLists.apply(this,["union"].concat(nt.call(arguments)))},u.prototype.intersect=function(){return this.combineLists.apply(this,["intersection"].concat(nt.call(arguments)))},u.prototype.diff=function(){return this.combineLists.apply(this,["difference"].concat(nt.call(arguments)))},u.prototype.complement=function(e,t){var n,r,i,s,o,u,a,f,l;return e==null&&(e={}),t==null&&(t=function(){}),s=e.from,i=e.exclude,u=e.name,r=e.description,l=e.tags,n=function(){return"Relative complement of "+o.join(" and ")+" in "+a.join(" and ")},a=O(s),o=O(i),u==null&&(u=n()),r==null&&(r=n()),l==null&&(l=[]),f={name:u,description:r,tags:l,lists:o,references:a},this.post(x,f).pipe(h(this)).done(t)},u.prototype.fetchWidgets=function(e){var t=this;return S(this,8,function(){return et.call(t,"widgets",H,B,"widgets",e)})},u.prototype.fetchWidgetMap=function(e){var t=this;return S(this,8,function(){var n,r;return n=R({},function(e,t){return e[t.name]=t,e}),((r=t.__wmap__)!=null?r:t.__wmap__=t.fetchWidgets().then(n)).done(e)})},u.prototype.fetchModel=function(e){return et.call(this,"model",d,v,"model").pipe(m.load).pipe(K({service:this})).done(e)},u.prototype.fetchSummaryFields=function(e){return et.call(this,"summaryFields",C,N,"classes",e)},u.prototype.fetchVersion=function(e){return et.call(this,"version",_,D,"version",e)},u.prototype.query=function(t,n){var i=this;return e.when(this.fetchModel(),this.fetchSummaryFields()).pipe(function(e,s){var o,u;return o=Y.defaults({},t,{model:e,summaryFields:s}),u=i,r(function(){this.fail(u.errorHandler),this.done(n);try{return this.resolve(new E(o,u))}catch(e){return this.reject(e)}})})},u.prototype.manageUserPreferences=function(e,t){var n=this;return S(this,11,function(){return n.makeRequest(e,y,t).pipe(z("preferences"))})},u.prototype.resolveIds=function(e,t){var n=this;return S(this,10,function(){var r;return r={data:JSON.stringify(e),dataType:"json",url:n.root+"ids",type:"POST",contentType:"application/json"},X.doReq(r).pipe(z("uid")).pipe(a.create(n)).done(t)})},u.prototype.createList=function(e,t,n){var r,i;return e==null&&(e={}),t==null&&(t=""),n==null&&(n=function(){}),r=F(Y.defaults,{token:this.token,tags:e.tags||[]}),i={data:Y.isArray(t)?t.map(function(e){return'"'+e+'"'}).join("\n"):t,dataType:"json",url:""+this.root+"lists?"+G(r(e)),type:"POST",contentType:"text/plain"},X.doReq(i).pipe(h(this)).done(n)},u}(),k.prototype.rowByRow=X.iterReq("POST",b,"json"),k.prototype.eachRow=k.prototype.rowByRow,k.prototype.recordByRecord=X.iterReq("POST",b,"jsonobjects"),k.prototype.eachRecord=k.prototype.recordByRecord,k.prototype.union=k.prototype.merge,k.prototype.difference=k.prototype.diff,k.prototype.symmetricDifference=k.prototype.diff,k.prototype.relativeComplement=k.prototype.complement,k.prototype.subtract=k.prototype.complement,k.flushCaches=function(){return d={},_={},C={},H={}},k.connect=function(e){return e==null&&(e={}),new k(e)},V.Service=k}.call(this);