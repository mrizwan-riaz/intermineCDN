(function(){var a,b,c,d,e,f,g,h,i;a="undefined"!=typeof exports,a?d=exports:(e=null!=(h=this.intermine)?h:this.intermine={},d=null!=(i=e.imjs)?i:e.imjs={}),d.VERSION="unknown",a?(c=require("fs"),f=require("path"),null!=process.mainModule&&(b=c.readFileSync(f.join(__dirname,"..","package.json"),"utf8"),g=JSON.parse(b),d.VERSION=g.version)):d.VERSION="2.10.5"}).call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;if(c="undefined"!=typeof exports,a="undefined"!=typeof console,b="undefined"!=typeof JSON,d=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],!c&&(b||jQuery.getScript("http://cdn.intermine.org/js/json3/3.2.2/json3.min.js"),null==Object.keys&&(f=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),Object.keys=function(a){var b,c,g,h,i;if("object"!=typeof a&&""!=typeof a||null===a)throw new TypeError("Object.keys called on a non-object");if(b=function(){var b;b=[];for(c in a)f.call(a,c)&&b.push(c);return b}(),e)for(h=0,i=d.length;i>h;h++)g=d[h],f.call(a,g)&&b.push(g);return b}),null==Array.prototype.map&&(Array.prototype.map=function(a){var b,c,d,e;for(e=[],c=0,d=this.length;d>c;c++)b=this[c],e.push(a(b));return e}),null==Array.prototype.filter&&(Array.prototype.filter=function(a){var b,c,d,e;for(e=[],c=0,d=this.length;d>c;c++)b=this[c],a(b)&&e.push(b);return e}),null==Array.prototype.reduce&&(Array.prototype.reduce=function(a,b){var c,d,e,f,g;for(e=this.slice(),c=arguments.length<2?e.pop():b,f=0,g=e.length;g>f;f++)d=e[f],c=a(c,d);return c}),null==Array.prototype.forEach&&(Array.prototype.forEach=function(a,b){var c,d,e,f,g;if(!a)throw new Error("No function provided");for(g=[],c=e=0,f=this.length;f>e;c=++e)d=this[c],g.push(a.call(null!=b?b:this,d,c,this));return g}),a||(this.console={log:function(){},error:function(){},debug:function(){}},"undefined"!=typeof window&&null!==window&&(window.console=this.console)),null==(k=console.log)&&(console.log=function(){}),null==(l=console.error)&&(console.error=function(){}),null==(m=console.debug)&&(console.debug=function(){}),null==console.log.apply))for(console.log("Your console needs patching."),n=["log","error","debug"],h=function(a){var b;return b=console[a],console[a]=function(a){return b(a)}},i=0,j=n.length;j>i;i++)g=n[i],h(g)}.call(this),function(a,b){var c=a._,d=a.jQuery;if("undefined"==typeof d)return null;var e=d;if(!e.support.cors&&window.XDomainRequest){console.log("Patching IE x-domain request support");var f=/^https?:\/\//i,g=/^get|post$/i,h=new RegExp("^"+location.protocol,"i"),i=/\/json/i,j=/\/xml/i,k=function(a,b){this.userOptions=a,this.options=b,this.userType=(a.dataType||"").toLowerCase(),c.bindAll(this)};k.prototype.constructor=k,k.prototype.send=function(a,b){this.xdr=new XDomainRequest,this.complete=b;var c=this.xdr;/^\d+$/.test(this.userOptions.timeout)&&(c.timeout=this.userOptions.timeout),c.ontimeout=function(){b(500,"timeout")},c.onerror=function(){b(500,"error",{text:c.responseText})},c.onload=this.onLoad;var d=this.userOptions.data&&e.param(this.userOptions.data)||"";c.open(this.options.type,this.options.url),c.send(d)},k.prototype.respond=function(a,b,c,e){var f=this.xdr;f.onload=f.onerror=f.ontimeout=f.onprogress=d.noop,delete this.xdr,d.event.trigger("ajaxStop"),this.complete(a,b,c,e)},k.prototype.abort=function(){xdr&&xdr.abort()},k.prototype.onLoad=function(){var a=this.xdr,c="Content-Length: "+a.responseText.length+"\r\nContent-Type: "+a.contentType,d={code:200,message:"success"},f={text:a.responseText};try{if("json"===this.userType||"text"!==this.userType&&i.test(a.contentType))try{f.json=e.parseJSON(a.responseText)}catch(g){d.code=500,d.message="parseerror"}else if("xml"===this.userType||"text"!==this.userType&&j.test(a.contentType)){var h=new ActiveXObject("Microsoft.XMLDOM");h.async=!1;try{h.loadXML(a.responseText)}catch(g){h=b}if(!h||!h.documentElement||h.getElementsByTagName("parsererror").length)throw d.code=500,d.message="parseerror","Invalid XML: "+a.responseText;f.xml=h}}catch(k){throw k}finally{this.complete(d.code,d.message,f,c)}},d.ajaxTransport("text html xml json",function(a,b){return a.crossDomain&&a.async&&g.test(a.type)&&f.test(b.url)&&h.test(b.url)?new k(b,a):void 0}),d.support.cors=!0}}.call(this,"undefined"==typeof exports?this:exports),function(){var a,b,c,d,e;a="undefined"!=typeof exports,a?b=exports:(c=null!=(d=this.intermine)?d:this.intermine={},b=null!=(e=c.constants)?e:c.constants={}),b.ACCEPT_HEADER={json:"application/json",jsonobjects:"application/json;type=objects",jsontable:"application/json;type=table",jsonrows:"application/json;type=rows",jsoncount:"application/json;type=count",jsonp:"application/javascript",jsonpobjects:"application/javascript;type=objects",jsonptable:"application/javascript;type=table",jsonprows:"application/javascript;type=rows",jsonpcount:"application/javascript;type=count"}}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=[].slice,p={}.hasOwnProperty;b="undefined"!=typeof exports,h="undefined"!=typeof exports&&null!==exports?exports:this,b?(a=require("underscore.deferred").Deferred,k=require("underscore")._):(a=h.jQuery.Deferred,k=h._,null==(m=h.intermine)&&(h.intermine={}),null==(n=(l=h.intermine).funcutils)&&(l.funcutils={}),h=h.intermine.funcutils),h.curry=d=function(){var a,b;return b=arguments[0],a=2<=arguments.length?o.call(arguments,1):[],function(){var c;return c=1<=arguments.length?o.call(arguments,0):[],b.apply(null,a.concat(c))}},h.error=function(b){return a(function(){return this.reject(new Error(b))}).promise()},h.success=i=function(){var b;return b=1<=arguments.length?o.call(arguments,0):[],a(function(){return this.resolve.apply(this,b)}).promise()},h.fold=e=function(a){return function(b,c){var d,e,f;if(1===arguments.length&&(c=(null!=b?b.slice():void 0)||b,b=(null!=c?c.shift():void 0)||{}),null==c)throw new Error("xs is null");if(null!=c.reduce)return c.reduce(a,b);e=b;for(d in c)f=c[d],e=null!=e?a(e,d,f):{k:f};return e}},h.take=function(a){return function(b){return null!=a?b.slice(0,a-1+1||9e9):b}},h.filter=function(a){return function(b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],a(c)&&f.push(c);return f}},h.omap=function(a){var b;return b=e(function(b,c,d){var e,f,g;return g=a(c,d),e=g[0],f=g[1],b[e]=f,b}),function(a){return b({},a)}},h.copy=h.omap(function(a,b){return[a,b]}),h.partition=function(a){return function(b){var c,d,e,f,g;for(d=[],c=[],f=0,g=b.length;g>f;f++)e=b[f],a(e)?d.push(e):c.push(e);return[d,c]}},h.id=f=function(a){return a},h.concatMap=function(a){return function(b){var c,d,e,f,g,h,i;for(e=void 0,h=0,i=b.length;i>h;h++)g=b[h],c=a(g),e=function(){var a;if(void 0===e)return c;if("string"==(a=typeof c)||"number"===a)return e+c;if(null!=c.slice)return e.concat(c);for(d in c)f=c[d],e[d]=f;return e}();return e}},h.flatMap=h.concatMap,h.sum=h.concatMap(f),h.AND=function(a,b){return a&&b},h.OR=function(a,b){return a||b},h.NOT=function(a){return!a},h.any=function(a,b){var c,d,e;for(null==b&&(b=f),d=0,e=a.length;e>d;d++)if(c=a[d],b(c))return!0;return!1},h.invoke=function(){var b,c;return c=arguments[0],b=2<=arguments.length?o.call(arguments,1):[],function(d){var e;return(null!=(e=d[c])?e.apply:void 0)?d[c].apply(d,b):a().reject("No method: "+c).promise()}},h.invokeWith=function(a,b,c){return null==b&&(b=[]),null==c&&(c=null),function(d){return d[a].apply(c||d,b)}},h.get=function(a){return function(b){return b[a]}},h.set=function(a,b){return function(c){var d,e;if(2===arguments.length)c[a]=b;else for(d in a)p.call(a,d)&&(e=a[d],c[d]=e);return c}},h.flip=function(a){return function(){var b;return b=1<=arguments.length?o.call(arguments,0):[],a.apply(null,b.reverse())}},c=function(a,b){return"This service requires a service at version "+a+" or above. This one is at "+b},h.REQUIRES_VERSION=function(a,b,d){return a.fetchVersion().pipe(function(a){return a>=b?d():error(c(b,a))})},h.dejoin=function(a){var b,c,d,e,f;for(f=a.views,d=0,e=f.length;e>d;d++)c=f[d],b=c.split("."),b.length>2&&a.addJoin(b.slice(1,-1).join("."));return a},j=e(function(a,b){return a.then(b)}),h.sequence=function(){var a;return a=1<=arguments.length?o.call(arguments,0):[],j(i(),k.flatten(a))},g=e(function(a,b){var c,d;if(c=b[0],d=b[1],null!=a[c])throw new Error("Duplicate key: "+c);return a[c]=d,a}),h.pairsToObj=function(a){return g({},a)}}.call(this),function(){var a,b,c,d,e,f,g=[].slice;a="undefined"!=typeof exports,e="undefined"!=typeof exports&&null!==exports?exports:this,a?d=e:(d=e.intermine,null==d&&(d=e.intermine={})),null==(f=d.compression)&&(d.compression={}),c=function(a){var b,c,d;for(b={},c=d=0;a>=0?a>=d:d>=a;c=a>=0?++d:--d)b[String.fromCharCode(c)]=c;return b},b=function(a){var b,c,d;for(d=[],b=c=0;a>=0?a>=c:c>=a;b=a>=0?++c:--c)d.push(String.fromCharCode(b));return d},d.compression.LZW={encode:function(a){var b,d,e,f,g,h,i,j,k;for(e=(a+"").split(""),h=[],i="",g=256,f=c(g),j=0,k=e.length;k>j;j++)b=e[j],d=i+b,d in f?i=d:(h.push(f[i]),f[d]=g++,i=String(b));return""!==i&&h.push(f[i]),h},decode:function(a){var c,d,e,f,h,i,j,k,l,m;for(e=256,d=b(e),f="",h=a[0],j=2<=a.length?g.call(a,1):[],k=String.fromCharCode(h),i=[k],l=0,m=j.length;m>l;l++)c=j[l],f=function(){if(d[c])return d[c];if(c===e)return k+k.charAt(0);throw new Error("Key is "+c)}(),i.push(f),d[e++]=k+f.charAt(0),k=f;return i.join("")}}}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;j=this.jQuery,m=this._,i=this.intermine,d=this.XDomainRequest,g=null!=(n=i.http)?n:i.http={},a=i.constants.ACCEPT_HEADER,o=i.funcutils,f=o.get,e=o.error,function(){var b,c,d;b={};for(c in a)d=a[c],b["text "+c]=j.parseJSON;return j.ajaxSetup({accepts:a,contents:{json:/json/},converters:b})}(),b=function(a){return j.Deferred(function(){return a.wasSuccessful?this.resolve(a):this.reject(a.error,a)})},c=function(a){return null==a&&(a=function(){}),function(b,c){if(0!==(null!=b?b.status:void 0))try{return a(JSON.parse(b.responseText).error)}catch(d){return a(c)}}},h=null!=d,k={PUT:"POST",DELETE:"GET"},h?(g.getMethod=function(a){var b;return null!=(b=k[a])?b:a},g.supports=function(a){return!(a in k)}):(g.getMethod=function(a){return a},g.supports=function(){return!0}),l=function(a){var b,c,d,e;return m.isArray(a)?a.length?(c=a[0],d=a[1],b=a[2],e=function(a){return m.each(a,null!=c?c:function(){})},[e,d,b]):[]:(e=function(b){return m.each(b,null!=a?a:function(){})},[e])},g.iterReq=function(a,b,c){return function(d,e,g,h,i){var j,k,l;return null==e&&(e={}),null==g&&(g=function(){}),null==h&&(h=function(){}),null==i&&(i=function(){}),2===arguments.length&&m.isFunction(e)&&(l=[e,{}],g=l[0],e=l[1]),j=m.extend({format:c},e,{query:d.toXML()}),k=function(a){return a.forEach(g)},this.makeRequest(a,b,j).fail(h).pipe(f("results")).done(g).done(i)}},g.doReq=function(a){var b,d;return d=a.error||this.errorHandler,a.error=c(d),b=j.Deferred(function(){var b,d=this;return b=j.ajax(a),b.then(function(){return d.resolve.apply(d,arguments)}),b.fail(c(function(a){return d.reject(a)}))}),b.promise()}}.call(this),function(){var a,b,c,d,e,f,g,h;b="undefined"!=typeof exports,b?(a=require("xmldom").DOMParser,g=exports,c=new a,f=function(a){var b;(null!=a?a.match("<.*>"):void 0)||(a+=">");try{a&&(b=c.parseFromString(a,"text/xml"))}catch(d){b=void 0}if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length)throw new Error("Invalid xml: "+a);return b}):(e=this.jQuery,d=this.intermine,g=null!=(h=d.xml)?h:d.xml={},f=e.parseXML),g.parse=f}.call(this),function(){var a,b,c,d,e,f;a="undefined"!=typeof exports,e="undefined"!=typeof exports&&null!==exports?exports:null!=(f=this.intermine)?f:this.intermine={},c=function(a,b){var c,d,e;e=[];for(c in a)d=a[c],e.push(b[c]=d);return e},d=["attributes","references","collections"],b=function(){function a(a){var b,e,f,g,h,i;for(this.name=a.name,this.attributes=a.attributes,this.references=a.references,this.collections=a.collections,this.fields={},this.__parents__=arguments[0]["extends"],g=0,h=d.length;h>g;g++)e=d[g],c(this[e],this.fields);i=this.collections;for(f in i)b=i[f],b.isCollection=!0}return a.prototype.toString=function(){var a,b;return"[Table name="+this.name+", fields=["+function(){var c,d;c=this.fields,d=[];for(a in c)b=c[a],d.push(a);return d}.call(this)+"]]"},a.prototype.parents=function(){var a;return(null!=(a=this.__parents__)?a:[]).slice()},a}(),e.Table=b}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=function(a,b){return function(){return a.apply(b,arguments)}},t=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};c="undefined"!=typeof exports,r="undefined"!=typeof exports&&null!==exports?exports:this,c?(l=r,q=require("underscore")._,b=(a=require("underscore.deferred")).Deferred,p=require("./util")):(q=r._,b=(a=r.jQuery).Deferred,l=r.intermine,p=l.funcutils),h=p.concatMap,k=p.get,g=p.any,n=p.set,i=p.copy,o=p.success,j=p.error,d={},e={},m=function(a,b,c){var d,e,f;return""+(null!=a?a.name:void 0)+"|"+(null!=a?null!=(f=a.service)?f.root:void 0:void 0)+"|"+b+":"+function(){var a;a=[];for(d in c)e=c[d],a.push(""+d+"="+e);return a}()},f=function(){function a(a){var b;this.root=a.root,this.model=a.model,this.descriptors=a.descriptors,this.subclasses=a.subclasses,this.displayName=a.displayName,this.ident=a.ident,this.allDescriptors=s(this.allDescriptors,this),this.getChildNodes=s(this.getChildNodes,this),this.getDisplayName=s(this.getDisplayName,this),this.isa=s(this.isa,this),this.append=s(this.append,this),this.getParent=s(this.getParent,this),this.getEndClass=s(this.getEndClass,this),this.containsCollection=s(this.containsCollection,this),this.isCollection=s(this.isCollection,this),this.isReference=s(this.isReference,this),this.isClass=s(this.isClass,this),this.isAttribute=s(this.isAttribute,this),this.isRoot=s(this.isRoot,this),this.end=q.last(this.descriptors),null==(b=this.ident)&&(this.ident=m(this.model,this,this.subclasses))}return a.prototype.isRoot=function(){return 0===this.descriptors.length},a.prototype.isAttribute=function(){return null!=this.end&&!(null!=this.end.referencedType)},a.prototype.isClass=function(){return this.isRoot()||null!=this.end.referencedType},a.prototype.isReference=function(){var a;return null!=(null!=(a=this.end)?a.referencedType:void 0)},a.prototype.isCollection=function(){var a,b;return null!=(a=null!=(b=this.end)?b.isCollection:void 0)?a:!1},a.prototype.containsCollection=function(){return g(this.descriptors,function(a){return a.isCollection})},a.prototype.getEndClass=function(){var a;return this.model.classes[this.subclasses[this.toString()]||(null!=(a=this.end)?a.referencedType:void 0)]||this.root},a.prototype.getParent=function(){var b;if(this.isRoot())throw new Error("Root paths do not have parents");return b={root:this.root,model:this.model,descriptors:q.initial(this.descriptors),subclasses:this.subclasses},new a(b)},a.prototype.append=function(b){var c,d;if(this.isAttribute())throw new Error(""+this+" is an attribute.");if(d=q.isString(b)?this.getType().fields[b]:b,null==d)throw new Error(""+b+" is not a field of "+this.getType());return c={root:this.root,model:this.model,descriptors:this.descriptors.concat(d),subclasses:this.subclasses},new a(c)},a.prototype.isa=function(a){var b,c;return this.isAttribute()?this.getType()===a:(b=a.name?a.name:""+a,c=this.getType(),b===c.name||t.call(this.model.getAncestorsOf(c),b)>=0)},a.prototype.getDisplayName=function(a){var b,c,e,f,g,l=this;return(c=this.displayName)?o(c):(null==(g=this.namePromise)&&(this.namePromise=(b=d[this.ident])?o(b):null==this.model.service?j("No service"):(f="model"+h(function(a){return"/"+a.name})(this.allDescriptors()),e=n({format:"json"})(i(this.subclasses)),this.model.service.get(f,e).then(k("display")).done(function(a){var b,c;return null!=(c=d[b=l.ident])?c:d[b]=a}))),this.namePromise.done(a))},a.prototype.getChildNodes=function(){var a,b,c,d,e;d=(null!=(c=this.getEndClass())?c.fields:void 0)||{},e=[];for(b in d)a=d[b],e.push(this.append(a));return e},a.prototype.allDescriptors=function(){return[this.root].concat(this.descriptors)},a.prototype.toString=function(){return this.allDescriptors().map(k("name")).join(".")},a.prototype.equals=function(a){return a&&null!=a.ident&&this.ident===a.ident},a.prototype.getType=function(){var a,b;return(null!=(a=this.end)?null!=(b=a.type)?b.replace(/java\.lang\./,""):void 0:void 0)||this.getEndClass()},a}(),f.prototype.toPathString=f.prototype.toString,f.parse=function(a,b,c){var d,g,h,i,j,k,l,n,o;return null==c&&(c={}),j=m(a,b,c),(d=e[j])?d:(n=(b+"").split("."),o=g=a.classes[n.shift()],k=o.name,h=function(){var d,e,f,h;for(h=[],d=0,e=n.length;e>d;d++){if(l=n[d],i=(null!=g?g.fields[l]:void 0)||(null!=(f=g=a.classes[c[k]])?f.fields[l]:void 0),!i)throw new Error("Could not find "+l+" in "+g+" when parsing "+b);k+="."+l,g=a.classes[i.type||i.referencedType],h.push(i)}return h}(),e[j]=new f({root:o,model:a,descriptors:h,subclasses:c,ident:j}))},f.flushCache=function(){return e={},d={}},l.PathInfo=f}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}},p=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};c="undefined"!=typeof exports,m="undefined"!=typeof exports&&null!==exports?exports:this,c?(h=m,l=require("underscore")._,b=(a=require("underscore.deferred")).Deferred,f=require("./table").Table,e=require("./path").PathInfo,k=require("./util").omap):(l=m._,b=(a=m.jQuery).Deferred,h=null!=(n=m.intermine)?n:m.intermine={},f=h.Table,e=h.PathInfo,k=h.funcutils.omap),g=l.flatten,i=l.intersection,j=k(function(a,b){return[a,new f(b)]}),d=function(){function a(a){var b;this.name=a.name,b=a.classes,this.findCommonType=o(this.findCommonType,this),this.findSharedAncestor=o(this.findSharedAncestor,this),this.getAncestorsOf=o(this.getAncestorsOf,this),this.getSubclassesOf=o(this.getSubclassesOf,this),this.getPathInfo=o(this.getPathInfo,this),this.classes=j(b)}return a.prototype.getPathInfo=function(a,b){return e.parse(this,a,b)},a.prototype.getSubclassesOf=function(a){var b,c,d,e,f;if(c=a&&a.name?a:this.classes[a],null==c)throw new Error(""+a+" is not a table");d=[c.name],e=this.classes;for(l in e)b=e[l],f=c.name,p.call(b.parents(),f)>=0&&(d=d.concat(this.getSubclassesOf(b)));return d},a.prototype.getAncestorsOf=function(a){var b,c,d,e,f;if(c=a&&a.name?a:this.classes[a],null==c)throw new Error(""+a+" is not a table");for(b=c.parents(),e=0,f=b.length;f>e;e++)d=b[e],b.push(this.getAncestorsOf(d));return g(b)},a.prototype.findSharedAncestor=function(a,b){var c,d,e;return null===b||null===a?null:a===b?a:(c=this.getAncestorsOf(a),p.call(c,b)>=0?b:(d=this.getAncestorsOf(b),p.call(d,a)>=0?a:null!=(e=i(c,d).shift())?e:null))},a.prototype.findCommonType=function(a){return null==a&&(a=[]),a.reduce(this.findSharedAncestor)},a}(),d.prototype.makePath=d.prototype.getPathInfo,d.prototype.findCommonTypeOfMultipleClasses=d.prototype.findCommonType,d.load=function(a){return new d(a)},d.INTEGRAL_TYPES=["int","Integer","long","Long"],d.FRACTIONAL_TYPES=["double","Double","float","Float"],d.NUMERIC_TYPES=d.INTEGRAL_TYPES.concat(d.FRACTIONAL_TYPES),d.BOOLEAN_TYPES=["boolean","Boolean"],h.Model=d}.call(this),function(){var a,b,c,d,e,f,g,h,i=function(a,b){return function(){return a.apply(b,arguments)}};b="undefined"!=typeof exports,h="undefined"!=typeof exports&&null!==exports?exports:this,b?(a=require("underscore.deferred").Deferred,g=require("underscore")._,e=require("./util").error,f=h):(g=h._,a=h.jQuery.Deferred,f=h.intermine,e=f.funcutils.error),d=function(a,b,c){return a.service.manageUserPreferences(c,b).done(function(b){return a.preferences=b})},c=function(){function a(a,b){var c;this.service=a,this.username=b.username,this.preferences=b.preferences,this.refresh=i(this.refresh,this),this.clearPreferences=i(this.clearPreferences,this),this.clearPreference=i(this.clearPreference,this),this.setPreferences=i(this.setPreferences,this),this.setPreference=i(this.setPreference,this),this.hasPreferences=null!=this.preferences,null==(c=this.preferences)&&(this.preferences={})}return a.prototype.setPreference=function(a,b){var c;return g.isString(a)?(c={},c[a]=b):null==b?c=a:e("Incorrect arguments to setPreference"),this.setPreferences(c)},a.prototype.setPreferences=function(a){return d(this,a,"POST")},a.prototype.clearPreference=function(a){return d(this,{key:a},"DELETE")},a.prototype.clearPreferences=function(){return d(this,{},"DELETE")},a.prototype.refresh=function(){return d(this,{},"GET")},a}(),f.User=c}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=function(a,b){return function(){return a.apply(b,arguments)}},r={}.hasOwnProperty,t=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b="undefined"!=typeof exports,p="undefined"!=typeof exports&&null!==exports?exports:this,b?(o=require("underscore")._,h=require("./util"),k=p):(o=p._,k=p.intermine,h=k.funcutils),i=h.get,l=h.invoke,d=h.REQUIRES_VERSION,n=h.set,g=h.dejoin,f="list/tags",e="lists/shares",a="lists/invitations",m=function(a){return"__folder__"===a.substr(0,a.indexOf(":"))},j=function(a){return s.substr(a.indexOf(":")+1)},c=function(){function b(a,b){var c,d;this.service=b,this.hasTag=q(this.hasTag,this);for(c in a)r.call(a,c)&&(d=a[c],this[c]=d);this.dateCreated=null!=this.dateCreated?new Date(this.dateCreated):null,this.folders=this.tags.filter(m).map(j)}return b.prototype.hasTag=function(a){return t.call(this.tags,a)>=0},b.prototype.query=function(a){return null==a&&(a=["*"]),this.service.query({select:a,from:this.type,where:[[this.type,"IN",this.name]]})},b.prototype.del=function(a){return this.service.makeRequest("DELETE","lists",{name:this.name},a)},b.prototype.fetchTags=function(a){var b=this;return this.service.makeRequest("GET","list/tags",{name:this.name}).pipe(function(a){return a.tags}).done(function(a){return b.tags=a,b.folders.filter(m).map(j)}).done(a)},b.prototype.addTags=function(a,b){var c=this;return this.service.makeRequest("POST","list/tags",{name:this.name,tags:a}).pipe(function(a){return a.tags}).done(function(a){return c.tags=a,c.folders.filter(m).map(j)}).done(b)},b.prototype.removeTags=function(a,b){var c=this;return this.service.makeRequest("DELETE","list/tags",{name:this.name,tags:a}).pipe(function(a){return a.tags}).done(function(a){return c.tags=a,c.folders.filter(m).map(j)}).done(b)},b.prototype.contents=function(a){return this.query().pipe(g).pipe(l("records")).done(a)},b.prototype.rename=function(a,b){var c=this;return this.service.post("lists/rename",{oldname:this.name,newname:a}).pipe(i("listName")).done(function(a){return c.name=a}).pipe(this.service.fetchList).done(b)},b.prototype.copy=function(a,b){var c,d,e,f,g,h,j,k=this;return null==a&&(a={}),null==b&&(b=function(){}),1===arguments.length&&o.isFunction(a)&&(g=[{},a],a=g[0],b=g[1]),o.isString(a)&&(a={name:""+a}),d=c=null!=(h=a.name)?h:""+this.name+"_copy",f=this.tags.concat(null!=(j=a.tags)?j:[]),e=this.query(["id"]),this.service.fetchLists().pipe(l("map",i("name"))).pipe(function(a){var g;for(g=1;t.call(a,d)>=0;)d=""+c+"-"+g++;return e.pipe(l("saveAsList",{name:d,tags:f,description:k.description})).done(b)})},b.prototype.enrichment=function(a,b){return this.service.enrichment(n({list:this.name})(a),b)},b.prototype.shareWithUser=function(a,b){return this.service.post(e,{list:this.name,"with":a}).done(b)},b.prototype.inviteUserToShare=function(b,c,d){return null==c&&(c=!0),null==d&&(d=function(){}),this.service.post(a,{list:this.name,to:b,notify:!!c}).done(d)},b}(),k.List=c}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m={}.hasOwnProperty,n=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},o=function(a,b){return function(){return a.apply(b,arguments)}};d="undefined"!=typeof exports,l="undefined"!=typeof exports&&null!==exports?exports:this,d?(b=require("underscore.deferred").Deferred,h=require("./util"),k=l):(b=l.jQuery.Deferred,k=l.intermine,h=k.funcutils),j=h.id,i=h.get,g=h.fold,f=h.concatMap,a=function(){function a(a){var b,c;for(b in a)m.call(a,b)&&(c=a[b],this[b]=c)}var b;return b=f(i("matches")),a.prototype.getMatches=function(a){var c;return"MATCH"===a?this.matches[a]:null!=(c=b(this.matches[a]))?c:[]},a.prototype.getMatchIds=function(a){return null!=a?this.getMatches(a).map(i("id")):this.allMatchIds()},a.prototype.goodMatchIds=function(){return this.getMatchIds("MATCH")},a.prototype.allMatchIds=function(){var a,b=this;return a=g(function(a,c){return a.concat(b.getMatchIds(c))}),a(this.goodMatchIds(),["DUPLICATE","WILDCARD","TYPE_CONVERTED","OTHER"])},a}(),e=function(){function a(a){var b,c;for(b in a)m.call(a,b)&&(c=a[b],this[b]=c)}var b,c,d;return b=f(j),c=function(a){var c,d;return b(function(){var b,e;b=a.identifiers,e=[];for(c in b)d=b[c],e.push(d);return e}())},d=function(a,b){return!(null!=b)||n.call(c(a),b)>=0},a.prototype.getMatches=function(a){var b,c;c=[];for(j in this)m.call(this,j)&&(b=this[j],d(b,a)&&c.push(b));return c},a.prototype.getMatchIds=function(a){var b,c;c=[];for(j in this)m.call(this,j)&&(b=this[j],d(b,a)&&c.push(j));return c},a.prototype.goodMatchIds=function(){return this.getMatchIds("MATCH")},a.prototype.allMatchIds=function(){return this.getMatchIds()},a}(),c=function(){function c(a,b){this.uid=a,this.service=b,this.del=o(this.del,this),this.fetchResults=o(this.fetchResults,this),this.fetchErrorMessage=o(this.fetchErrorMessage,this),this.fetchStatus=o(this.fetchStatus,this)}return c.prototype.fetchStatus=function(a){return this.service.get("ids/"+this.uid+"/status").pipe(i("status")).done(a)},c.prototype.fetchErrorMessage=function(a){return this.service.get("ids/"+this.uid+"/status").pipe(i("message")).done(a)},c.prototype.fetchResults=function(){var b,c;return b=this.service.get("ids/"+this.uid+"/result").pipe(i("results")),c=this.service.fetchVersion(),c.then(function(c){return b.then(function(b){return c>=16?new a(b):new e(b)})})},c.prototype.del=function(a){return this.service.makeRequest("DELETE","ids/"+this.uid,{},a)},c.prototype.poll=function(a,c,d){var e,f,g=this;return f=b().done(a).fail(c).progress(d),e=this.fetchStatus(),e.fail(f.reject),e.done(function(a){switch(f.notify(a),a){case"SUCCESS":return g.fetchResults().then(f.resolve,f.reject);case"ERROR":return g.fetchErrorMessage().then(f.reject,f.reject);default:return g.poll(f.resolve,f.reject,f.notify)}}),f.promise()},c}(),c.prototype.wait=c.prototype.poll,c.create=function(a){return function(b){return new c(b,a)}},k.IDResolutionJob=c,k.CategoryResults=a,k.IdResults=e}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},ab=function(a,b){return function(){return a.apply(b,arguments)}},bb=[].slice,cb={}.hasOwnProperty;e="undefined"!=typeof exports,R="undefined"!=typeof exports&&null!==exports?exports:this,e?(z=R,Q=require("underscore")._,d=(a=require("underscore.deferred")).Deferred,O=require("querystring").stringify,z.xml=require("./xml"),Y=require("./util"),I=Y.pairsToObj,s=Y.filter,J=Y.partition,t=Y.fold,N=Y.take,n=Y.concatMap,x=Y.id,u=Y.get,C=Y.invoke):(Q=R._,D=R.jQuery,z=R.intermine,Z=z.funcutils,I=Z.pairsToObj,s=Z.filter,J=Z.partition,t=Z.fold,N=Z.take,n=Z.concatMap,x=Z.id,u=Z.get,C=Z.invoke,d=(a=D).Deferred,O=function(a){return D.param(a,!0)}),v=function(a){var b;if(b=Q.isString(a)?g.OP_DICT[a.toLowerCase()]:null,!b)throw new Error("Illegal constraint operator: "+a);return b},b=["path","op","code"],i=b.concat(["value","extraValue"]),h=["rowByRow","eachRow","recordByRecord","eachRecord","records","rows","table","tableRows"],f=function(a){return Q.compose(a.fetchList,u("listName"))},c=[null,"A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],p=function(a){return null==a&&(a=""),a.substr(a.indexOf("."))},m=function(a){return null!=a?"<value>"+Q.escape(a)+"</value>":"<nullValue/>"},j=function(a,b){var c,d;return function(){var e;e=[];for(c in a)d=a[c],_.call(b,c)>=0&&e.push(""+c+'="'+Q.escape(d)+'" ');return e}().join("")},H=function(a){return"<constraint "+j(a,b)+"/>"},P=function(a){return"<constraint "+j(a,["path","type"])+"/>"},L=function(a){return"<constraint "+j(a,i)+"/>"},F=function(a){return"<constraint "+j(a,b)+">"+n(m)(a.values)+"</constraint>"},y=function(a){return"<constraint "+j(a,b)+'ids="'+a.ids.join(",")+'"/>'},k=function(a){var b;return null!=a.values?F(a):null!=a.ids?y(a):null==a.op?P(a):(b=a.op,_.call(g.NULL_OPS,b)>=0?H(a):L(a))},w=function(a){return a.replace(/^[^\.]+\./,"")},o=function(a){var b,c,d,e,f,g,h,i;return f=a.path,g=a.type,e=a.op,h=a.value,i=a.values,c=a.extraValue,d=a.ids,b=a.code,d=null!=d?d.slice():void 0,i=null!=i?i.slice():void 0,G({path:f,type:g,op:e,value:h,values:i,extraValue:c,ids:d,code:b})},l=function(a){var b;return b=o(a),b.path=w(b.path),b},G=function(a){var b,c;for(b in a)c=a[b],null==c&&delete a[b];return a},q=function(a,b){return"Did not remove a single constraint. original = "+a+", reduced = "+b},B=function(a,b){var c,d,e,f,h,i;if(c={path:a},null===b)c.op="IS NULL";else if(Q.isArray(b))c.op="ONE OF",c.values=b;else if(Q.isString(b)||Q.isNumber(b))i="function"==typeof b.toUpperCase?b.toUpperCase():void 0,_.call(g.NULL_OPS,i)>=0?c.op=b:(c.op="=",c.value=b);else if(e=function(){var a;a=[];for(d in b)h=b[d],a.push(d);return a}(),_.call(e,"isa")>=0)Q.isArray(b.isa)?(c.op=d,c.values=b.isa):c.type=b.isa;else{_.call(e,"extraValue")>=0&&(c.extraValue=b.extraValue);for(d in b)f=b[d],"extraValue"!==d&&(c.op=d,Q.isArray(f)?c.values=f:c.value=f)}return c},A=function(a){var b,c,d,e;return a=a.slice(),c={path:a.shift()},1===a.length?(b=a[0],e="function"==typeof b.toUpperCase?b.toUpperCase():void 0,_.call(g.NULL_OPS,e)>=0?c.op=b:c.type=b):a.length>=2&&(c.op=a[0],d=a[1],Q.isArray(d)?c.values=d:c.value=d,3===a.length&&(c.extraValue=a[2])),c},M=function(a){var b,c,d,e,f,g,h;if(null==a)return[];for(c=a.split(/\s+/),d=function(){var a,b,d;for(d=[],e=a=0,b=c.length/2;b>=0?b>a:a>b;e=b>=0?++a:--a)d.push(2*e);return d}(),h=[],f=0,g=d.length;g>f;f++)b=d[f],h.push([c[b],c[b+1]]);return h},K=function(){var a,b;return b=this.sortOrder,this.sortOrder=function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],this.isRelevant(a.path)&&e.push(a);return e}.call(this),b.length!==this.sortOrder.length?this.trigger("change:sortorder change:orderby",this.sortOrder.slice()):void 0},g=function(){function a(a,b){this.addConstraint=ab(this.addConstraint,this),this.expandStar=ab(this.expandStar,this),this.adjustPath=ab(this.adjustPath,this),this.select=ab(this.select,this);var c,d,e,f,h,i,j,k,l,m,n,o,p,q=this;for(Q.defaults(this,{constraints:[],views:[],joins:{},constraintLogic:"",sortOrder:""}),null==a&&(a={}),this.displayNames=Q.extend({},null!=(i=null!=(j=a.displayNames)?j:a.aliases)?i:{}),k=["name","title","comment","description"],d=0,e=k.length;e>d;d++)c=k[d],null!=a[c]&&(this[c]=a[c]);this.service=null!=b?b:{},this.model=null!=(l=a.model)?l:{},this.summaryFields=null!=(m=a.summaryFields)?m:{},this.root=null!=(n=a.root)?n:a.from,this.maxRows=null!=(o=null!=(p=a.size)?p:a.limit)?o:a.maxRows,this.start=null!=(f=null!=(h=a.start)?h:a.offset)?f:0,this.select(a.views||a.view||a.select||[]),this.addConstraints(a.constraints||a.where||[]),this.addJoins(a.joins||a.join||[]),this.orderBy(a.sortOrder||a.orderBy||[]),null!=a.constraintLogic&&(this.constraintLogic=a.constraintLogic),g=function(a,b){var c,d,e;return c=q.getPathInfo(a).getEndClass(),e=[a],d=c&&b>0?Q.flatten(Q.map(c.fields,function(c){return g(""+a+"."+c.name,b-1)})):[],Q.flatten(e.concat(d))},this.on("change:views",K,this)}var b,e,g,h,i,j,m,r;return a.JOIN_STYLES=["INNER","OUTER"],a.BIO_FORMATS=["gff3","fasta","bed"],a.NULL_OPS=["IS NULL","IS NOT NULL"],a.ATTRIBUTE_VALUE_OPS=["=","!=",">",">=","<","<=","CONTAINS","LIKE","NOT LIKE"],a.MULTIVALUE_OPS=["ONE OF","NONE OF"],a.TERNARY_OPS=["LOOKUP"],a.LOOP_OPS=["=","!="],a.LIST_OPS=["IN","NOT IN"],a.OP_DICT={"=":"=","==":"==",eq:"=",eqq:"==","!=":"!=",ne:"!=",">":">",gt:">",">=":">=",ge:">=","<":"<",lt:"<","<=":"<=",le:"<=",contains:"CONTAINS",CONTAINS:"CONTAINS",like:"LIKE",LIKE:"LIKE","not like":"NOT LIKE","NOT LIKE":"NOT LIKE",lookup:"LOOKUP","IS NULL":"IS NULL","is null":"IS NULL","IS NOT NULL":"IS NOT NULL","is not null":"IS NOT NULL","ONE OF":"ONE OF","one of":"ONE OF","NONE OF":"NONE OF","none of":"NONE OF","in":"IN","not in":"NOT IN",IN:"IN","NOT IN":"NOT IN",WITHIN:"WITHIN",within:"WITHIN",OVERLAPS:"OVERLAPS",overlaps:"OVERLAPS",ISA:"ISA",isa:"ISA"},g=function(){},a.prototype.on=function(a,b,c){var d,e,f,g,h,i,j;
for(a=a.split(/\s+/),d=null!=(h=this._callbacks)?h:this._callbacks={};e=a.shift();)f=null!=(i=d[e])?i:d[e]={},g=null!=(j=f.tail)?j:f.tail=f.next={},g.callback=b,g.context=c,f.tail=g.next={};return this},a.prototype.bind=function(){var a;return a=1<=arguments.length?bb.call(arguments,0):[],this.on.apply(this,a)},a.prototype.off=function(a,b,c){var d,e,f,g,h,i,j,k,l,m;if(null==a)return this._callbacks={},this;for(a=a.split(/\s+/),d=null!=(m=this._callbacks)?m:this._callbacks={},k=0,l=a.length;l>k;k++)if(f=a[k],null!=b)for(e=h=d[f]||{},g=h.tail;(i=e.next)!==g;)j=!(null!=c&&i.context!==c||b!==i.callback),j?(e.next=i.next||g,i=e):e=i;else delete d[f];return this},a.prototype.unbind=function(){var a;return a=1<=arguments.length?bb.call(arguments,0):[],this.off.apply(this,a)},a.prototype.once=function(a,b,c){var d,e=this;return d=function(){var f;return f=1<=arguments.length?bb.call(arguments,0):[],b.apply(c,f),e.off(a,d)},this.on(a,d)},a.prototype.emit=function(){var a;return a=1<=arguments.length?bb.call(arguments,0):[],this.trigger.apply(this,a)},a.prototype.trigger=function(){var a,b,c,d,e,f,g,h;if(e=arguments[0],g=2<=arguments.length?bb.call(arguments,1):[],c=this._callbacks,!c)return this;for(a=c.all,(e=e.split(/\s+/)).push(null);d=e.shift();)a&&e.push({next:a.next,tail:a.tail,event:d}),(f=c[d])&&e.push({next:f.next,tail:f.tail});for(;f=e.pop();)for(h=f.tail,b=f.event?[f.event].concat(g):g;(f=f.next)!==h;)f.callback.apply(f.context||this,b);return this},i=["name","view","sortOrder","constraintLogic","title","description","comment"],e=["path","type","op","code","value","ids"],m=function(a,b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],a.hasAttribute(c)&&f.push([c,a.getAttribute(c)]);return f},h=function(a,b){var c,d,e,f,g;for(f=a.getElementsByTagName(b),g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(c);return g},r=function(a){return function(b){return b.getAttribute(a)}},a.fromXML=function(a){var b,c,d,f,g,j,k;if(c=z.xml.parse(a),j=h(c,"query")[0]||h(c,"template")[0],!j)throw new Error("no query in xml");return f=r("path"),k=r("style"),g=I(m(j,i)),g.view=g.view.split(/\s+/),g.sortOrder=M(g.sortOrder),g.joins=function(){var a,b,c,e;for(c=h(j,"join"),e=[],a=0,b=c.length;b>a;a++)d=c[a],"OUTER"===k(d)&&e.push(f(d));return e}(),g.constraints=function(){var a,c,d,f;for(d=h(j,"constraint"),f=[],a=0,c=d.length;c>a;a++)b=d[a],f.push(function(a){var b,c,d,f,g;return b=I(m(a,e)),null!=b.ids&&(b.ids=function(){var a,c,d,e;for(d=b.ids.split(","),e=[],a=0,c=d.length;c>a;a++)g=d[a],e.push(parseInt(g,10));return e}()),f=h(a,"value"),f.length&&(b.values=function(){var a,b,e;for(e=[],a=0,b=f.length;b>a;a++)d=f[a],e.push(function(){var a,b,e,f;for(e=d.childNodes,f=[],a=0,b=e.length;b>a;a++)c=e[a],f.push(c.data);return f}().join(""));return e}()),b}(b));return f}(),g},a.prototype.removeFromSelect=function(a){var b,c,d,e;return a=Q.isString(a)?[a]:a||[],b=Q.compose(this.expandStar,this.adjustPath),a=Q.flatten(function(){var c,e,f;for(f=[],c=0,e=a.length;e>c;c++)d=a[c],f.push(b(d));return f}()),this.sortOrder=function(){var b,d,e,f,g;for(e=this.sortOrder,g=[],b=0,d=e.length;d>b;b++)c=e[b],f=c.path,_.call(a,f)>=0||g.push(c);return g}.call(this),this.views=function(){var b,c,d,f;for(d=this.views,f=[],b=0,c=d.length;c>b;b++)e=d[b],_.call(a,e)>=0||f.push(e);return f}.call(this),this.trigger("remove:view",a),this.trigger("change:views",this.views)},a.prototype.removeConstraint=function(a,b){var c,d,e,f;if(null==b&&(b=!1),e=this.constraints,d="string"==typeof a?function(b){return b.code===a}:function(b){var c,d;return b.path===a.path&&b.op===a.op&&b.value===a.value&&b.extraValue===a.extraValue&&a.type===b.type&&(null!=(c=b.values)?c.join("%%"):void 0)===(null!=(d=a.values)?d.join("%%"):void 0)},f=function(){var a,b,f;for(f=[],a=0,b=e.length;b>a;a++)c=e[a],d(c)||f.push(c);return f}(),f.length!==e.length-1)throw new Error(q(e,f));return this.constraints=f,b?void 0:(this.trigger("change:constraints"),this.trigger("removed:constraints",Q.difference(e,f)))},a.prototype.addToSelect=function(a){var b,c,d,e,f;if(a=Q.isString(a)?[a]:a||[],d=Q.flatten([Q.map(a,Q.compose(this.expandStar,this.adjustPath))]),b=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],(_.call(this.views,c)>=0||Q.indexOf(d,c)!==Q.lastIndexOf(d,c))&&e.push(c);return e}.call(this),b.length)throw new Error(""+b+" already in the select list");for(e=0,f=d.length;f>e;e++)c=d[e],this.views.push(c);return this.trigger("add:view change:views",d)},a.prototype.select=function(a){return this.views=[],this.addToSelect(a),this},a.prototype.adjustPath=function(a){return a=a&&a.name?a.name:""+a,null!=this.root?a.match("^"+this.root)||(a=this.root+"."+a):this.root=a.split(".")[0],a},a.prototype.getPossiblePaths=function(a){var b,c,d;return null==a&&(a=3),null==(c=this._possiblePaths)&&(this._possiblePaths={}),null!=(d=(b=this._possiblePaths)[a])?d:b[a]=g(this.root,a)},a.prototype.getPathInfo=function(a){var b,c,d;return b=this.adjustPath(a),c=null!=(d=this.model)?"function"==typeof d.getPathInfo?d.getPathInfo(b,this.getSubclasses()):void 0:void 0,c&&b in this.displayNames&&(c.displayName=this.displayNames[b]),c},a.prototype.makePath=a.prototype.getPathInfo,j=Q.compose(I,s(u(1)),C("map",function(a){return[a.path,a.type]})),a.prototype.getSubclasses=function(){return j(this.constraints)},a.prototype.getType=function(a){return this.getPathInfo(a).getType()},a.prototype.getViewNodes=function(){var a,b=this;return a=function(a){return b.getPathInfo(a).getParent()},Q.uniq(Q.map(this.views,a),!1,function(a){return a.toPathString()})},a.prototype.isInView=function(a){var b,c,d;if(b=this.getPathInfo(a),!b)throw new Error("Invalid path: "+a);return b.isAttribute()?(d=b.toString(),_.call(this.views,d)>=0):(c=b.toString(),Q.any(this.getViewNodes(),function(a){return a.toString()===c}))},a.prototype.isConstrained=function(a,b){var c,d,e=this;if(null==b&&(b=!1),c=this.getPathInfo(a),!c)throw new Error("Invalid path: "+a);return d=function(a){return null!=a.op&&a.path===c.toString()},!c.isAttribute()&&b&&(d=function(a){return null!=a.op&&(a.path===c.toString()||c.equals(e.getPathInfo(a.path).getParent()))}),Q.any(this.constraints,d)},a.prototype.canHaveMultipleValues=function(a){return this.getPathInfo(a).containsCollection()},a.prototype.getQueryNodes=function(){var a,b,c,d;return d=this.getViewNodes(),b=function(){var b,d,e,f;for(e=this.constraints,f=[],b=0,d=e.length;d>b;b++)a=e[b],null==a.type&&(c=this.getPathInfo(a.path),c.isAttribute()?f.push(c.getParent()):f.push(c));return f}.call(this),Q.uniq(d.concat(b),!1,String)},a.prototype.isInQuery=function(a){var b,c,d,e,f,g;if(c=this.getPathInfo(a)){for(d=c.toPathString(),g=this.views.concat(function(){var a,c,d,e;for(d=this.constraints,e=[],a=0,c=d.length;c>a;a++)b=d[a],null==b.type&&e.push(b.path);return e}.call(this)),e=0,f=g.length;f>e;e++)if(a=g[e],0===a.indexOf(d))return!0;return!1}return!0},a.prototype.isRelevant=function(a){var b,c,d;return c=this.getPathInfo(a),c.isAttribute()&&(c=c.getParent()),d=c.toString(),b=this.getViewNodes(),Q.any(b,function(a){return a.toPathString()===d})},a.prototype.expandStar=function(a){var b,c,d,e,f;if(/\*$/.test(a)){if(f=a.substr(0,a.lastIndexOf(".")),c=function(a){return f+a},b=this.getType(f),/\.\*$/.test(a)&&b&&this.summaryFields[b.name])return d=Q.compose(c,p),function(){var a,c,f,g;for(f=this.summaryFields[b.name],g=[],a=0,c=f.length;c>a;a++)e=f[a],this.hasView(e)||g.push(d(e));return g}.call(this);if(/\.\*\*$/.test(a))return d=Q.compose(c,function(a){return"."+a.name}),Q.uniq(Q.union(this.expandStar(f+".*"),Q.map(b.attributes,d)))}return a},a.prototype.isOuterJoin=function(a){return"OUTER"===this.joins[this.adjustPath(a)]},a.prototype.hasView=function(a){return this.views&&Q.include(this.views,this.adjustPath(a))},a.prototype.count=function(a){if(this.service.count)return this.service.count(this,a);throw new Error("This query has no service with count functionality attached.")},a.prototype.appendToList=function(a,b){var c,d,e,g;return c=a&&a.name?a.name:""+a,e=this.makeListQuery(),d={listName:c,query:e.toXML()},g=(null!=a?a.name:void 0)?function(b){return a.size=b.size}:function(){},this.service.post("query/append/tolist",d).pipe(f(this.service)).done(b,g)},a.prototype.makeListQuery=function(){var a,b,c,d,e;for(b=this.clone(),1===b.views.length&&null!==b.views[0]&&b.views[0].match(/\.id$/)||b.select(["id"]),e=this.getViewNodes(),c=0,d=e.length;d>c;c++)a=e[c],this.isOuterJoined(a)||b.isInView(a||b.isConstrained(a))||null==a.getEndClass().fields.id||b.addConstraint([a.append("id"),"IS NOT NULL"]);return b},a.prototype.saveAsList=function(a,b){var c,d;return d=this.makeListQuery(),c=Q.clone(a),c.listName=c.listName||c.name,c.query=d.toXML(),a.tags&&(c.tags=a.tags.join(";")),this.service.post("query/tolist",c).pipe(f(this.service)).done(b)},a.prototype.summarise=function(a,b,c){return this.filterSummary(a,"",b,c)},a.prototype.summarize=function(){var a;return a=1<=arguments.length?bb.call(arguments,0):[],this.summarise.apply(this,a)},a.prototype.filterSummary=function(a,b,c,e){var f,g,h,i;return null==e&&(e=function(){}),Q.isFunction(c)&&(i=[c,null],e=i[0],c=i[1]),a=this.adjustPath(a),h=this.clone(),Q.include(h.views,a)||h.views.push(a),g={query:h.toXML(),summaryPath:a,format:"jsonrows"},c&&(g.size=c),b&&(g.filterTerm=b),f=function(a){return d(function(){var b,c,d;return b=a.results.map(function(a){return a.count=parseInt(a.count,10),a}),c={uniqueValues:a.uniqueValues},null!=(null!=(d=b[0])?d.max:void 0)&&Q.extend(c,b[0]),this.resolve(b,c,a.filteredCount)})},this.service.post("query/results",g).pipe(f).done(e)},a.prototype.clone=function(b){var c,d,e,f,g;if(c=new a(this,this.service),null==(f=c._callbacks)&&(c._callbacks={}),b){g=this._callbacks;for(d in g)cb.call(g,d)&&(e=g[d],c._callbacks[d]=e);c.off("change:views",K,this)}return c},a.prototype.next=function(){var a;return a=this.clone(),this.maxRows&&(a.start=this.start+this.maxRows),a},a.prototype.previous=function(){var a;return a=this.clone(),a.start=this.maxRows?this.start-this.maxRows:0,a},a.prototype.getSortDirection=function(a){var b,c,d,e,f;for(a=this.adjustPath(a),f=this.sortOrder,d=0,e=f.length;e>d;d++)c=f[d],c.path===a&&(b=c.direction);return b},a.prototype.isOuterJoined=function(a){return a=this.adjustPath(a),Q.any(this.joins,function(b,c){return"OUTER"===b&&0===a.indexOf(c)})},a.prototype.getOuterJoin=function(a){var b,c=this;return a=this.adjustPath(a),b=Q.sortBy(Q.keys(this.joins),u("length")).reverse(),Q.find(b,function(b){return"OUTER"===c.joins[b]&&0===a.indexOf(b)})},a.prototype._parse_sort_order=function(a){var b,c,d;return d=a,Q.isString(a)?d={path:a,direction:"ASC"}:Q.isArray(a)?(c=a[0],b=a[1],d={path:c,direction:b}):null==a.path&&(c=Q.keys(a)[0],b=Q.values(a)[0],d={path:c,direction:b}),d.path=this.adjustPath(d.path),d.direction=d.direction.toUpperCase(),d},a.prototype.addOrSetSortOrder=function(a){var b,c,d,e,f;if(a=this._parse_sort_order(a),b=this.getSortDirection(a.path),null==b)return this.addSortOrder(a);if(b!==a.direction){for(f=this.sortOrder,d=0,e=f.length;e>d;d++)c=f[d],c.path===a.path&&(c.direction=a.direction);return this.trigger("change:sortorder",this.sortOrder)}},a.prototype.addSortOrder=function(a){return this.sortOrder.push(this._parse_sort_order(a)),this.trigger("add:sortorder",a),this.trigger("change:sortorder",this.sortOrder)},a.prototype.orderBy=function(a){var b,c,d;for(this.sortOrder=[],c=0,d=a.length;d>c;c++)b=a[c],this.addSortOrder(this._parse_sort_order(b));return this.trigger("set:sortorder change:sortorder",this.sortOrder)},a.prototype.addJoins=function(a){var b,c,d,e,f,g,h;if(Q.isArray(a)){for(g=[],e=0,f=a.length;f>e;e++)b=a[e],g.push(this.addJoin(b));return g}h=[];for(c in a)d=a[c],h.push(this.addJoin({path:c,style:d}));return h},a.prototype.addJoin=function(b){var c,d,e;if(Q.isString(b)&&(b={path:b,style:"OUTER"}),b.path=this.adjustPath(b.path),b.style=null!=(c=null!=(d=b.style)?d.toUpperCase():void 0)?c:b.style,e=b.style,_.call(a.JOIN_STYLES,e)<0)throw new Error("Invalid join style: "+b.style);return this.joins[b.path]=b.style,this.trigger("set:join",b.path,b.style)},a.prototype.setJoinStyle=function(a,b){return null==b&&(b="OUTER"),a=this.adjustPath(a),b=b.toUpperCase(),this.joins[a]!==b&&(this.joins[a]=b,this.trigger("change:joins",{path:a,style:b})),this},a.prototype.addConstraints=function(a){var b,c,d,e,f,g,h=this;if(this.__silent__=!0,Q.isArray(a))for(f=0,g=a.length;g>f;f++)b=a[f],this.addConstraint(b);else{e=function(a,b){return h.addConstraint(B(a,b))};for(d in a)c=a[d],e(d,c)}return this.__silent__=!1,this.trigger("add:constraint"),this.trigger("change:constraints")},a.prototype.addConstraint=function(a){if(a=Q.isArray(a)?A(a):o(a),a.path=this.adjustPath(a.path),null==a.type)try{a.op=v(a.op)}catch(b){throw new Error("Illegal operator: "+a.op)}return this.constraints.push(a),null!=this.constraintLogic&&""!==this.constraintLogic&&(this.constraintLogic="("+this.constraintLogic+") and "+c[this.constraints.length]),this.__silent__||(this.trigger("add:constraint",a),this.trigger("change:constraints")),this},a.prototype.getSorting=function(){var a;return function(){var b,c,d,e;for(d=this.sortOrder,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(""+a.path+" "+a.direction);return e}.call(this).join(" ")},a.prototype.getConstraintXML=function(){var a,b;return b=function(){var b,c,d,e;for(d=this.constraints,e=[],b=0,c=d.length;c>b;b++)a=d[b],(null==a.type||this.isInQuery(a.path))&&e.push(a);return e}.call(this),b.length?n(k)(n(x)(J(function(a){return null!=a.type})(b))):""},a.prototype.getJoinXML=function(){var a,b,c;return c=function(){var c,d;c=this.joins,d=[];for(a in c)b=c[a],this.isInQuery(a)&&"OUTER"===b&&d.push('<join path="'+a+'" style="OUTER"/>');return d}.call(this),c.join("")},a.prototype.toXML=function(){var a,b,c,d;return a={model:this.model.name,view:this.views.join(" "),sortOrder:this.getSorting(),constraintLogic:this.constraintLogic},null!=this.name&&(a.name=this.name),b=function(){var b;b=[];for(c in a)d=a[c],d&&b.push(c+'="'+d+'"');return b}().join(" "),"<query "+b+" >"+this.getJoinXML()+this.getConstraintXML()+"</query>"},a.prototype.toJSON=function(){var a,b,c,d,e;return G({name:this.name,title:this.title,comment:this.comment,description:this.description,constraintLogic:this.constraintLogic,from:this.root,select:function(){var a,b,c,d;for(c=this.views,d=[],a=0,b=c.length;b>a;a++)e=c[a],d.push(w(e));return d}.call(this),orderBy:function(){var a,d,e,f,g;for(e=this.sortOrder,g=[],a=0,d=e.length;d>a;a++)f=e[a],c=f.path,b=f.direction,g.push({path:w(c),direction:b});return g}.call(this),joins:function(){var a,b;a=this.joins,b=[];for(c in a)d=a[c],"OUTER"===d&&b.push(w(c));return b}.call(this),where:function(){var b,c,d,e;for(d=this.constraints,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(l(a));return e}.call(this)})},a.prototype.fetchCode=function(a,b){var c;return c={query:this.toXML(),lang:a},this.service.post("query/code",c).pipe(this.service.VERIFIER).pipe(u("code")).done(b)},a.prototype.save=function(a,b){var c,d=this;return null!=a&&(this.name=a),c={data:this.toXML(),contentType:"application/xml; charset=UTF-8",url:this.service.root+"query",type:"POST",dataType:"json"},this.service.doReq(c).pipe(this.service.VERIFIER).pipe(u("name")).done(b,function(a){return d.name=a})},a.prototype.getCodeURI=function(a){var b,c;return b={query:this.toXML(),lang:a,format:"text"},null!=(null!=(c=this.service)?c.token:void 0)&&(b.token=this.service.token),""+this.service.root+"query/code?"+O(b)},a.prototype.getExportURI=function(b){var c,d;return null==b&&(b="tab"),_.call(a.BIO_FORMATS,b)>=0?this["get"+b.toUpperCase()+"URI"]():(c={query:this.toXML(),format:b},null!=(null!=(d=this.service)?d.token:void 0)&&(c.token=this.service.token),""+this.service.root+"query/results?"+O(c))},a.prototype.fetchQID=function(a){return this.service.post("queries",{query:this.toXML()}).then(function(a){return a.id}).done(a)},b=function(a){return a.append("primaryIdentifier").toString()},a.prototype.__bio_req=function(a,c){var d,e;return e=this.makeListQuery(),d=function(b){return Q.any(a,function(a){return b.isa(a)})},e.views=N(c)(function(){var a,e,f,g;for(f=this.getViewNodes(),g=[],a=0,e=f.length;e>a;a++)c=f[a],d(c)&&g.push(b(c));return g}.call(this)),{query:e.toXML(),format:"text"}},a.prototype._fasta_req=function(){return this.__bio_req(["SequenceFeature","Protein"],1)},a.prototype._gff3_req=function(){return this.__bio_req(["SequenceFeature"])},a.prototype._bed_req=a.prototype._gff3_req,a}(),g.ATTRIBUTE_OPS=Q.union(g.ATTRIBUTE_VALUE_OPS,g.MULTIVALUE_OPS,g.NULL_OPS),g.REFERENCE_OPS=Q.union(g.TERNARY_OPS,g.LOOP_OPS,g.LIST_OPS),$=g.BIO_FORMATS,S=function(a){var b,c,d;return c="_"+a+"_req",b="get"+a.toUpperCase(),d=b+"URI",g.prototype[b]=function(b,d){var e,f,g;return null==b&&(b={}),null==d&&(d=function(){}),Q.isFunction(b)&&(g=[{},b],b=g[0],d=g[1]),null!=(null!=b?b.view:void 0)&&(b.view=function(){var a,c,d,e;for(d=b.view,e=[],a=0,c=d.length;c>a;a++)f=d[a],e.push(this.getPathInfo(f).toString());return e}.call(this)),e=Q.extend(this[c](),b),this.service.post("query/results/"+a,e).done(d)},g.prototype[d]=function(b,d){var e,f,g;return null==b&&(b={}),Q.isFunction(b)&&(g=[{},b],b=g[0],d=g[1]),null!=(null!=b?b.view:void 0)&&(b.view=function(){var a,c,d,e;for(d=b.view,e=[],a=0,c=d.length;c>a;a++)f=d[a],e.push(this.getPathInfo(f).toString());return e}.call(this)),e=Q.extend(this[c](),b),null!=this.service.token&&(e.token=this.service.token),""+this.service.root+"query/results/"+a+"?"+O(e)}};for(U=0,W=$.length;W>U;U++)r=$[U],S(r);for(T=function(a){return function(){var b,c,d,e;if(c=arguments[0],b=2<=arguments.length?bb.call(arguments,1):[],this.service[a])return null==c?c={}:Q.isFunction(c)&&(c={},b=function(){var a,b,c;for(c=[],a=0,b=arguments.length;b>a;a++)d=arguments[a],c.push(d);return c}.apply(this,arguments)),Q.defaults(c,{start:this.start,size:this.maxRows}),(e=this.service)[a].apply(e,[this,c].concat(bb.call(b)));throw new Error("Service does not provide '"+a+"'.")}},V=0,X=h.length;X>V;V++)E=h[V],g.prototype[E]=T(E);z.Query=g}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb=function(a,b){return function(){return a.apply(b,arguments)}},cb=[].slice;j="undefined"!=typeof exports,_="undefined"!=typeof exports&&null!==exports?exports:this,j?($=require("underscore")._,d=(a=require("underscore.deferred")).Deferred,q=require("./model").Model,v=require("./query").Query,n=require("./lists").List,F=require("./user").User,i=require("./id-resolution-job").IDResolutionJob,O=require("./util"),Z=require("querystring").stringify,R=require("./http"),S=exports):($=_._,U=_.jQuery,S=_.intermine,d=(a=U).Deferred,Z=function(a){return U.param(a,!0)},q=S.Model,v=S.Query,n=S.List,F=S.User,i=S.IDResolutionJob,O=S.funcutils,R=S.http),W=O.pairsToObj,V=O.omap,P=O.get,X=O.set,T=O.invoke,Y=O.success,N=O.error,w=O.REQUIRES_VERSION,M=O.dejoin,G={},o={},A={},J={},c="http://",H="version",D="templates",k="lists",p="model",z="summaryfields",t="query/results",u="search",K="widgets",e="list/enrichment",L="listswithobject",l={union:"lists/union",intersection:"lists/intersect",difference:"lists/diff"},x="lists/subtract",I="user/whoami",C=t+"/tablerows",s="user/preferences",r="path/values",h=function(a){return a},f=/^https?:\/\//i,g=/service\/?$/i,y="/service/",b=function(a){var b,c;return j&&null!=a.stack?console.error(a.stack):(b=(null!=a?a.stack:void 0)?[a.stack]:arguments,"undefined"!=typeof console&&null!==console?null!=(c=console.error||console.log)?c.apply(console,b):void 0:void 0)},ab=function(a,b,c,d,e){var f,g,h,i=this;return f=null!=(h=this[a])?h:this[a]=this.useCache&&(g=b[this.root])?Y(g):this.get(c).pipe(P(d)).done(function(a){return b[i.root]=a}),f.done(e)},Q=function(a){return function(b){return d(function(){var c;return(c=$.find(b,function(b){return b.name===a}))?this.resolve(c):this.reject('List "'+a+'" not found among: '+b.map(P("name")))})}},m=function(a,b){return null==b&&(b="listName"),$.compose(a.fetchList,P(b))},E=function(a){var b,c,d,e,f,g;for(null==a&&(a=[]),e=$.isArray(a)?a:[a],g=[],c=0,d=e.length;d>c;c++)b=e[c],g.push(null!=(f=b.name)?f:b);return g},B=function(){function h(a){var d,e,h,i,k=this;if(this.root=a.root,this.token=a.token,this.errorHandler=a.errorHandler,this.DEBUG=a.DEBUG,this.help=a.help,e=a.noCache,this.createList=bb(this.createList,this),this.resolveIds=bb(this.resolveIds,this),this.query=bb(this.query,this),this.fetchWidgetMap=bb(this.fetchWidgetMap,this),this.fetchWidgets=bb(this.fetchWidgets,this),this.complement=bb(this.complement,this),this.fetchListsContaining=bb(this.fetchListsContaining,this),this.fetchList=bb(this.fetchList,this),this.findLists=bb(this.findLists,this),this.fetchLists=bb(this.fetchLists,this),this.fetchTemplates=bb(this.fetchTemplates,this),this.tableRows=bb(this.tableRows,this),this.values=bb(this.values,this),this.rows=bb(this.rows,this),this.records=bb(this.records,this),this.table=bb(this.table,this),this.pathValues=bb(this.pathValues,this),this.fetchUser=bb(this.fetchUser,this),this.whoami=bb(this.whoami,this),this.findById=bb(this.findById,this),this.count=bb(this.count,this),this.enrichment=bb(this.enrichment,this),null==this.root)throw new Error("No service root provided. This is required");f.test(this.root)||(this.root=c+this.root),g.test(this.root)||(this.root=this.root+y),this.root=this.root.replace(/ice$/,"ice/"),null==(h=this.errorHandler)&&(this.errorHandler=b),null==(i=this.help)&&(this.help="no.help.available@dev.null"),this.useCache=!e,d=j?"":location.protocol+"//"+location.host,this.getFormat=function(a){return null==a&&(a="json"),/jsonp/.test(a)||j||U.support.cors||d.substring(0,k.root.length)===k.root?a:a.replace("json","jsonp")}}var B;return h.prototype.doReq=R.doReq,h.prototype.post=function(a,b){return null==b&&(b={}),this.makeRequest("POST",a,b)},h.prototype.get=function(a,b){return this.makeRequest("GET",a,b)},h.prototype.makeRequest=function(a,b,c,d,e){var f,g,h,i,j,k;return null==a&&(a="GET"),null==b&&(b=""),null==c&&(c={}),null==d&&(d=function(){}),null==e&&(e=!1),$.isArray(d)&&(j=d,d=j[0],g=j[1]),$.isArray(c)&&(c=W(c)),i=this.root+b,null==g&&(g=this.errorHandler),this.token&&(c.token=this.token),c.format=this.getFormat(c.format),/jsonp/.test(c.format)&&(c.method=a,a="GET",i+="?callback=?"),f=/json/.test(c.format)?"json":"text",R.supports(a)||(k=[a,R.getMethod(a)],c.method=k[0],a=k[1]),"DELETE"===a&&(i+="?"+Z(c)),h={data:c,dataType:f,success:d,error:g,url:i,type:a},this.doReq(h,e)},h.prototype.enrichment=function(a,b){var c=this;return w(this,8,function(){return c.get(e,$.defaults({},a,{maxp:.05,correction:"Holm-Bonferroni"})).pipe(P("results")).done(b)})},h.prototype.search=function(a,b){var c=this;return null==a&&(a={}),null==b&&(b=function(){}),w(this,9,function(){var d,e,f,g,h,i;if($.isFunction(a)&&(h=[a,{}],b=h[0],a=h[1]),$.isString(a)&&(a={q:a}),f=$.defaults({},a,{q:""}),delete f.facets,a.facets){i=a.facets;for(d in i)g=i[d],f["facet_"+d]=g}return e=function(a){return Y(a.results,a.facets)},c.post(u,f).pipe(e).done(b)})},h.prototype.count=function(a,b){var c,d;return null==b&&(b=function(){}),a?null!=a.toPathString?(c=a.isClass()?a.append("id"):a,this.pathValues(c,"count").done(b)):null!=a.toXML?(d={query:a.toXML(),format:"jsoncount"},this.post(t,d).pipe(P("count")).done(b)):$.isString(a)?this.fetchModel().pipe(T("makePath",a.replace(/\.\*$/,".id"))).pipe(this.count).done(b):this.query(a).pipe(this.count).done(b):N("Not enough arguments")},h.prototype.findById=function(a,b,c){return this.query({from:a,select:["**"],where:{id:b}}).pipe(M).pipe(T("records")).pipe(P(0)).done(c)},h.prototype.find=function(a,b,c){return this.query({from:a,select:["**"],where:[[a,"LOOKUP",b]]}).pipe(M).pipe(T("records")).done(c)},h.prototype.whoami=function(a){var b=this;return w(this,9,function(){return b.get(I).pipe(P("user")).pipe(function(a){return new F(b,a)}).done(a)})},h.prototype.fetchUser=function(){var a;return a=1<=arguments.length?cb.call(arguments,0):[],this.whoami.apply(this,a)},h.prototype.pathValues=function(a,b,c){var d=this;return null==b&&(b={}),null==c&&(c=function(){}),w(this,6,function(){var e,f;$.isString(b)&&(e=b,b={}),"count"!==e&&(e="results"),f=function(a){var b,c;return b="count"===e?"jsoncount":"json",c={format:b,path:a.toString(),typeConstraints:JSON.stringify(a.subclasses)},d.post(r,c).pipe(P(e))};try{return d.fetchModel().pipe(T("makePath",a,a.subclasses||b)).pipe(f).done(c)}catch(g){return N(g)}})},h.prototype.doPagedRequest=function(a,b,c,d,e){var f,g,h=this;return null==c&&(c={}),null==e&&(e=function(){}),null!=a.toXML?($.isFunction(c)&&(g=[c,{}],e=g[0],c=g[1]),f=$.defaults({},{query:a.toXML(),format:d},c),this.post(b,f).pipe(function(a){return Y(a.results,a)}).done(e)):this.query(a).pipe(function(a){return h.doPagedRequest(a,b,c,d,e)})},h.prototype.table=function(a,b,c){return this.doPagedRequest(a,t,b,"jsontable",c)},h.prototype.records=function(a,b,c){return this.doPagedRequest(a,t,b,"jsonobjects",c)},h.prototype.rows=function(a,b,c){return this.doPagedRequest(a,t,b,"json",c)},h.prototype.values=function(a,b,c){var d=this;return null==c&&(c=function(){}),null==a?N("No query term supplied"):null!=a.descriptors||$.isString(a)?this.pathValues(a,b,c):this.query(a).then(function(e){return 1!==e.views.length?N("Expected one column, got "+a.views.length):d.rows(e,b).then(T("map",P(0))).done(c)})},h.prototype.tableRows=function(a,b,c){return this.doPagedRequest(a,C,b,"json",c)},h.prototype.fetchTemplates=function(a){return this.get(D).pipe(P("templates")).done(a)},h.prototype.fetchLists=function(a){return this.findLists("",a)},h.prototype.findLists=function(a,b){var c=this;return null==a&&(a=""),null==b&&(b=function(){}),this.fetchVersion().pipe(function(d){var e;return a&&13>d?N("Finding lists by name on the server requires version 13. This is only "+d):(e=function(a){var b,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)b=a[d],f.push(new n(b,c));return f},c.get(k,{name:a}).pipe(P("lists")).pipe(e).done(b))})},h.prototype.fetchList=function(a,b){var c=this;return this.fetchVersion().pipe(function(d){return 13>d?c.findLists().pipe(Q(a)).done(b):c.findLists(a).pipe(P(0)).done(b)})},h.prototype.fetchListsContaining=function(a,b){var c,d=this;return c=function(a){var b,c,e,f;for(f=[],c=0,e=a.length;e>c;c++)b=a[c],f.push(new n(b,d));return f},this.get(L,a).pipe(P("lists")).pipe(c).done(b)},h.prototype.combineLists=function(a,b,c){var d,e;return d=$.pick(b,"name","description"),null==(e=d.description)&&(d.description=""+a+" of "+b.lists.join(", ")),d.tags=(b.tags||[]).join(";"),d.lists=(b.lists||[]).join(";"),this.get(l[a],d).pipe(m(this)).done(c)},h.prototype.merge=function(){return this.combineLists.apply(this,["union"].concat(cb.call(arguments)))},h.prototype.intersect=function(){return this.combineLists.apply(this,["intersection"].concat(cb.call(arguments)))},h.prototype.diff=function(){return this.combineLists.apply(this,["difference"].concat(cb.call(arguments)))},h.prototype.complement=function(a,b){var c,d,e,f,g,h,i,j,k;return null==a&&(a={}),null==b&&(b=function(){}),f=a.from,e=a.exclude,h=a.name,d=a.description,k=a.tags,c=function(){return"Relative complement of "+g.join(" and ")+" in "+i.join(" and ")},i=E(f),g=E(e),null==h&&(h=c()),null==d&&(d=c()),null==k&&(k=[]),j={name:h,description:d,tags:k,lists:g,references:i},this.post(x,j).pipe(m(this)).done(b)},h.prototype.fetchWidgets=function(a){var b=this;return w(this,8,function(){return ab.call(b,"widgets",J,K,"widgets",a)})},B=V(function(a){return[a.name,a]}),h.prototype.fetchWidgetMap=function(a){var b=this;return w(this,8,function(){var c;return(null!=(c=b.__wmap__)?c:b.__wmap__=b.fetchWidgets().then(B)).done(a)})},h.prototype.fetchModel=function(a){return ab.call(this,"model",o,p,"model").pipe(q.load).pipe(X({service:this})).done(a)},h.prototype.fetchSummaryFields=function(a){return ab.call(this,"summaryFields",A,z,"classes",a)},h.prototype.fetchVersion=function(a){return ab.call(this,"version",G,H,"version",a)},h.prototype.query=function(b,c){var e=this;return a.when(this.fetchModel(),this.fetchSummaryFields()).pipe(function(a,f){var g,h;return g=$.extend({},b,{model:a,summaryFields:f}),h=e,d(function(){this.fail(h.errorHandler),this.done(c);try{return this.resolve(new v(g,h))}catch(a){return this.reject(a)}})})},h.prototype.manageUserPreferences=function(a,b){var c=this;return w(this,11,function(){return c.makeRequest(a,s,b).pipe(P("preferences"))})},h.prototype.resolveIds=function(a,b){var c=this;return w(this,10,function(){var d;return d={type:"POST",url:c.root+"ids",contentType:"application/json",data:JSON.stringify(a),dataType:"json"},c.doReq(d).pipe(P("uid")).pipe(i.create(c)).done(b)})},h.prototype.createList=function(a,b,c){var d,e,f=this;return null==a&&(a={}),null==b&&(b=""),null==c&&(c=function(){}),d=function(b){return $.defaults({token:f.token,tags:a.tags||[]},b)},e={data:$.isArray(b)?b.map(function(a){return'"'+a+'"'}).join("\n"):b,dataType:"json",url:""+this.root+"lists?"+Z(d(a)),type:"POST",contentType:"text/plain"},this.doReq(e).pipe(m(this)).done(c)},h}(),B.prototype.rowByRow=function(){var a,b,c,d=this;return c=arguments[0],a=2<=arguments.length?cb.call(arguments,1):[],b=R.iterReq("POST",t,"json"),null!=c.toXML?b.apply(this,arguments):this.query(arguments[0]).then(function(b){return d.rowByRow.apply(d,[b].concat(cb.call(a)))})},B.prototype.eachRow=B.prototype.rowByRow,B.prototype.recordByRecord=function(){var a,b,c,d=this;return c=arguments[0],a=2<=arguments.length?cb.call(arguments,1):[],b=R.iterReq("POST",t,"jsonobjects"),null!=c.toXML?b.apply(this,arguments):this.query(arguments[0]).then(function(b){return d.recordByRecord.apply(d,[b].concat(cb.call(a)))})},B.prototype.eachRecord=B.prototype.recordByRecord,B.prototype.union=B.prototype.merge,B.prototype.difference=B.prototype.diff,B.prototype.symmetricDifference=B.prototype.diff,B.prototype.relativeComplement=B.prototype.complement,B.prototype.subtract=B.prototype.complement,B.flushCaches=function(){return o={},G={},A={},J={}},B.connect=function(a){return null==a&&(a={}),new B(a)},S.Service=B}.call(this);